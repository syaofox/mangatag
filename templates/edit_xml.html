<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MangaTag v{{ version }} - 编辑压缩包内 XML</title>
  <link rel="stylesheet" href="/static/css/style.css" />
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script>htmx.config.allowScriptTags = true;</script>
</head>
<body>
  <div class="main-content">
  <h1>编辑压缩包内 XML <span class="version-badge">v{{ version }}</span></h1>
  <p class="subtitle">扫描目录中的 .cbz/.zip，读取 ComicInfo.xml 后在下方 CSV 中编辑并保存回压缩包。第一列为 FileName（固定），其余列为元数据。</p>

  <section class="section dir-section">
    <h2 class="section-title">目录选择</h2>
    <form id="dir-form" class="dir-form-grid">
      <div class="control-group dir-path-group">
        <label for="base_path">基路径</label>
        <div class="path-with-browse">
          <input type="text" id="base_path" name="base_path" value="{{ default_base_path }}" placeholder="如 /home/user/outputs" />
          <button type="button" id="browse-btn" class="btn" title="浏览文件夹">浏览</button>
        </div>
      </div>
      <div class="control-group dir-select-group">
        <label for="dir_list">漫画文件夹</label>
        <div class="form-row dir-list-row">
          <input type="text" id="dir_list" name="dir_list" list="dir_list_datalist"
                 placeholder="输入或选择子目录" class="dir-list-input" />
          <button type="button" id="refresh-dirs"
            hx-get="/api/dirs"
            hx-include="#base_path"
            hx-target="#dir_list_datalist"
            hx-swap="innerHTML"
            hx-trigger="click">刷新</button>
          <span class="htmx-indicator">加载中…</span>
          <datalist id="dir_list_datalist">
            <option value="">-- 选择 --</option>
          </datalist>
        </div>
      </div>
      <div class="control-group dir-edit-group">
        <label for="edit_dir">章节压缩包目录</label>
        <input type="text" id="edit_dir" name="comic_dir" placeholder="如 /path/to/comic/dir" />
      </div>
    </form>
  </section>

  <section class="section scan-section">
    <h2 class="section-title">扫描选项</h2>
    <div class="form-row scan-options-row">
      <label class="control-group scan-option-item">
        <input type="checkbox" id="include_header" name="include_header" checked /> 包含表头
      </label>
      <div class="control-group scan-option-item">
        <label for="sort_mode">排序</label>
        <select id="sort_mode" name="sort_mode" class="sort-select">
          {% for opt in sort_choices %}
          <option value="{{ opt }}" {% if opt == "按数字大小顺序" %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="button" id="scan-btn" class="btn btn-primary">扫描目录并读取 ComicInfo.xml</button>
      <span class="htmx-indicator">扫描中…</span>
    </div>
  </section>

  <section class="section import-export-section">
    <h2 class="section-title">下载 / 导入</h2>
    <div class="form-row">
      <form id="export-form" method="POST" action="/export" target="_blank" style="display: inline-flex; align-items: center;">
        <input type="hidden" name="csv_text" id="export_csv_hidden" value="" />
        <input type="hidden" name="include_header" id="export_include_header" value="true" />
        <input type="hidden" name="comic_dir" id="export_comic_dir" value="" />
        <button type="submit" class="btn" id="export-btn">下载 CSV</button>
      </form>
      <form id="import-form" hx-post="/import" hx-target="#csv-area" hx-swap="outerHTML" hx-encoding="multipart/form-data" class="form-row">
        <input type="hidden" name="include_header" id="import_include_header" value="true" />
        <label for="import_file" style="margin: 0;">导入 CSV</label>
        <input type="file" id="import_file" name="import_file" accept=".csv" required />
        <button type="submit" id="import-btn">导入</button>
      </form>
      <button type="button" id="batch-rename-btn" class="btn" title="根据规则批量重命名文件名">批量改名</button>
    </div>
  </section>

  <section class="section save-section">
    <label style="display: inline-flex; align-items: center; margin: 0;">
      <input type="checkbox" id="check_count" name="check_count" checked /> 检测文档数量一致（CSV 与扫描数量需一致）
    </label>
    <form id="save-form" style="display: inline;">
      <input type="hidden" name="scan_token" id="scan_token" value="" />
      <input type="hidden" name="csv_text" id="save_csv_hidden" value="" />
      <input type="hidden" name="include_header" id="save_include_header" value="true" />
      <input type="hidden" name="check_count" id="save_check_count" value="true" />
      <button type="submit" id="save-btn" class="btn btn-primary">保存修改到压缩包</button>
    </form>
    <span id="save-indicator" class="htmx-indicator" style="display: none;">保存中…</span>
  </section>

  <section class="section csv-section">
  <div id="csv-area">
    {% include "partials/csv_editor.html" %}
  </div>
  </section>

  <div id="browse-modal" role="dialog" aria-label="浏览文件夹">
    <div class="dialog">
      <h3>选择基路径目录</h3>
      <div id="browse-current" class="current-path">/</div>
      <div id="browse-list" class="folder-list"></div>
      <div class="actions">
        <button type="button" id="browse-cancel" class="btn" style="background: #666;">取消</button>
        <button type="button" id="browse-select" class="btn">选择此目录</button>
      </div>
    </div>
  </div>

  <div id="batch-rename-modal" class="csv-find-replace-modal" role="dialog" aria-label="批量改名">
    <div class="csv-fr-dialog batch-rename-dialog">
      <div class="batch-rename-header">
        <h3>批量改名</h3>
        <button type="button" id="batch-rename-close-btn" class="batch-rename-close-btn" title="关闭">×</button>
      </div>
      <div class="batch-rename-form">
        <div class="batch-rename-rule-wrap">
          <div class="batch-rename-rule-row">
            <label for="batch-rename-rule">命名规则</label>
            <button type="button" id="batch-rename-placeholder-btn" class="btn batch-rename-placeholder-btn" title="插入占位符">插入占位符 ▼</button>
          </div>
          <div id="batch-rename-placeholder-popover" class="batch-rename-placeholder-popover">
          <div class="batch-rename-placeholder-hint">点击插入到规则中，<code>{列名:N}</code> 可补零</div>
          <div id="batch-rename-placeholder-list" class="batch-rename-placeholder-list"></div>
          </div>
        </div>
        <input type="text" id="batch-rename-rule" placeholder="{Series} - {Number:3} - {Title}" />
        <label class="batch-rename-opt">
          <input type="checkbox" id="batch-rename-ws-enable" checked /> 启用空白替换
        </label>
        <div class="batch-rename-ws-row">
          <label for="batch-rename-ws-char">替换为</label>
          <input type="text" id="batch-rename-ws-char" value="_" maxlength="1" class="batch-input-small" />
        </div>
        <div class="batch-rename-conflict-row">
          <label for="batch-rename-conflict">冲突处理</label>
          <select id="batch-rename-conflict">
            <option value="suffix">自动加序号 (2)、(3)...</option>
            <option value="skip">跳过并报告</option>
          </select>
        </div>
        <div class="batch-rename-preview-row">
          <button type="button" id="batch-rename-preview-btn" class="btn batch-rename-preview-btn">预览</button>
          <span id="batch-rename-preview-hint" class="batch-rename-preview-hint">点击预览查看改名前后对比</span>
        </div>
        <div id="batch-rename-preview" class="batch-rename-preview"></div>
      </div>
      <div class="csv-fr-actions">
        <button type="button" class="btn batch-rename-cancel" style="background:#666;">取消</button>
        <button type="button" class="btn batch-rename-confirm">确定</button>
      </div>
    </div>
  </div>
  </div>

  <aside class="log-panel" id="log-panel">
    <div class="log-panel-resize-handle" id="log-resize-handle" title="拖动调节宽度"></div>
    <div class="log-panel-header">
      <h2 class="section-title">日志</h2>
      <button type="button" class="log-panel-toggle" id="log-panel-toggle" title="收起/展开">◀</button>
    </div>
    <div class="log-panel-body">
      <div id="unified-log" class="log">{% if scan_log %}{{ scan_log }}{% endif %}{% if save_log %}

--- 保存 ---

{{ save_log }}{% endif %}</div>
    </div>
  </aside>

  <script>
    // 浏览文件夹
    (function() {
      var modal = document.getElementById('browse-modal');
      var currentEl = document.getElementById('browse-current');
      var listEl = document.getElementById('browse-list');
      var browseBtn = document.getElementById('browse-btn');
      var cancelBtn = document.getElementById('browse-cancel');
      var selectBtn = document.getElementById('browse-select');
      var basePathInput = document.getElementById('base_path');
      var currentPath = '';

      function loadBrowse(path) {
        var url = '/api/browse' + (path ? '?path=' + encodeURIComponent(path) : '');
        fetch(url).then(function(r) {
          if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || '加载失败'); });
          return r.json();
        }).then(function(data) {
          currentPath = data.current;
          currentEl.textContent = data.current || '/';
          listEl.innerHTML = '';
          if (data.parent) {
            var parentBtn = document.createElement('button');
            parentBtn.type = 'button';
            parentBtn.className = 'folder-item parent';
            parentBtn.textContent = '上一级';
            parentBtn.dataset.path = data.parent;
            parentBtn.addEventListener('click', function() { loadBrowse(data.parent); });
            listEl.appendChild(parentBtn);
          }
          data.entries.forEach(function(e) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'folder-item';
            btn.textContent = e.name;
            btn.dataset.path = e.path;
            btn.addEventListener('click', function() { loadBrowse(e.path); });
            listEl.appendChild(btn);
          });
        }).catch(function(err) {
          currentEl.textContent = '错误: ' + err.message;
          listEl.innerHTML = '';
        });
      }

      browseBtn.addEventListener('click', function() {
        var start = basePathInput.value.trim();
        modal.classList.add('open');
        loadBrowse(start || undefined);
      });
      cancelBtn.addEventListener('click', function() { modal.classList.remove('open'); });
      selectBtn.addEventListener('click', function() {
        if (currentPath) basePathInput.value = currentPath;
        modal.classList.remove('open');
      });
      modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.classList.remove('open');
      });
    })();

    // 导入/扫描后，若 #csv-area 被替换，需手动渲染表格（allowScriptTags 可能仍不执行，此作为后备）
    function maybeRenderCsvTable() {
      var dataEl = document.getElementById('csv-initial-data');
      var wrap = document.getElementById('csv-table-wrap');
      if (!dataEl || !wrap) return;
      var csv = '';
      if (dataEl.textContent && dataEl.textContent.trim()) {
        try {
          csv = JSON.parse(dataEl.textContent);
        } catch (e) {
          csv = '';
        }
      }
      var ta = document.getElementById('csv_text');
      if (ta) ta.value = csv;
      if (window.csvEditor && window.csvEditor.render) window.csvEditor.render('csv-table-wrap', csv);
    }
    document.body.addEventListener('htmx:afterSwap', function(ev) {
      if (ev.detail && ev.detail.target && (ev.detail.target.id === 'csv-area' || (ev.detail.target.querySelector && ev.detail.target.querySelector('#csv-initial-data')))) maybeRenderCsvTable();
    });
    document.body.addEventListener('htmx:afterSettle', function() {
      if (document.getElementById('csv-initial-data') && !document.getElementById('csv-data-table')) {
        setTimeout(maybeRenderCsvTable, 0);
      }
    });

    // 漫画文件夹输入：简繁体不敏感搜索，动态更新 datalist
    (function() {
      var input = document.getElementById('dir_list');
      var baseInput = document.getElementById('base_path');
      var datalist = document.getElementById('dir_list_datalist');
      if (!input || !baseInput || !datalist) return;

      var lastController = null;

      function escapeHtml(str) {
        return (str || '').replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/"/g, '&quot;');
      }

      function updateDatalist(entries) {
        var html = '<option value=\"\">-- 选择 --</option>';
        if (Array.isArray(entries)) {
          entries.forEach(function(item) {
            var rel, search;
            if (typeof item === 'string') {
              rel = item;
              search = item;
            } else {
              rel = item && item.rel || '';
              search = item && item.search || rel;
            }
            if (!rel) return;
            var escRel = escapeHtml(rel);
            var escSearch = escapeHtml(search);
            // value 用于浏览器匹配（含多种繁简形式），data-rel 保留真实相对路径
            html += '<option value=\"' + escSearch + '\" data-rel=\"' + escRel + '\" label=\"' + escRel + '\"></option>';
          });
        }
        datalist.innerHTML = html;
      }

      function fetchDirs(q) {
        var base = baseInput.value.trim();
        var params = new URLSearchParams();
        if (base) params.append('base_path', base);
        if (q) params.append('q', q);
        if (lastController) {
          lastController.abort();
        }
        lastController = ('AbortController' in window) ? new AbortController() : null;
        var opts = {};
        if (lastController) {
          opts.signal = lastController.signal;
        }
        fetch('/api/dirs-search?' + params.toString(), opts)
          .then(function(res) { return res.ok ? res.json() : { entries: [] }; })
          .then(function(data) {
            updateDatalist((data && data.entries) || []);
          })
          .catch(function(err) {
            if (err && err.name === 'AbortError') return;
            // 出错时保持现有列表
          });
      }

      input.addEventListener('input', function() {
        fetchDirs(this.value.trim());
      });

      input.addEventListener('focus', function() {
        fetchDirs(this.value.trim());
      });
    })();

    // 扫描：流式请求 /scan-stream，逐条追加到扫描日志；
    // 同时通过 /scan-json 拉取 CSV 文本并直接刷新表格与 scan_token。
    (function() {
      var scanBtn = document.getElementById('scan-btn');
      if (!scanBtn) return;
      scanBtn.addEventListener('click', function() {
        var unifiedLogEl = document.getElementById('unified-log');
        if (unifiedLogEl) unifiedLogEl.textContent = '扫描中…';

        var comicDir = (document.getElementById('edit_dir') || {}).value || '';
        var includeHeaderCb = document.getElementById('include_header');
        var sortModeEl = document.getElementById('sort_mode');
        var includeHeaderVal = includeHeaderCb && includeHeaderCb.checked ? 'true' : 'false';
        var sortModeVal = sortModeEl ? sortModeEl.value : '按数字大小顺序';

        var formData1 = new FormData();
        formData1.append('comic_dir', comicDir);
        formData1.append('include_header', includeHeaderVal);
        formData1.append('sort_mode', sortModeVal);

        // 1）流式日志
        fetch('/scan-stream', { method: 'POST', body: formData1 })
          .then(function(res) {
            if (!res.body) return;
            var reader = res.body.getReader();
            var decoder = new TextDecoder();
            function read() {
              return reader.read().then(function(opt) {
                if (opt.done) return;
                var text = decoder.decode(opt.value, { stream: true });
                if (unifiedLogEl) {
                  // 若是第一次块并且仍然是「扫描中…」，先清空
                  if (unifiedLogEl.textContent === '扫描中…') {
                    unifiedLogEl.textContent = '';
                  }
                  unifiedLogEl.textContent += text;
                }
                return read();
              });
            }
            return read();
          })
          .catch(function(err) {
            if (unifiedLogEl) {
              unifiedLogEl.textContent = (unifiedLogEl.textContent || '') + '\n请求失败: ' + err.message;
            }
          });

        // 2）JSON 结果：直接刷新 CSV 表格与 scan_token
        var formData2 = new FormData();
        formData2.append('comic_dir', comicDir);
        formData2.append('include_header', includeHeaderVal);
        formData2.append('sort_mode', sortModeVal);
        fetch('/scan-json', { method: 'POST', body: formData2 })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (!data || !data.ok) {
              if (unifiedLogEl && data && data.error) {
                unifiedLogEl.textContent = data.error;
              }
              return;
            }
            var csv = data.csv_text || '';
            var ta = document.getElementById('csv_text');
            if (ta) ta.value = csv;
            var tokenInput = document.getElementById('scan_token');
            if (tokenInput && data.scan_token) {
              tokenInput.value = data.scan_token;
            }
            if (window.csvEditor && window.csvEditor.render) {
              window.csvEditor.render('csv-table-wrap', csv);
            }
          })
          .catch(function(err) {
            if (unifiedLogEl) {
              unifiedLogEl.textContent = (unifiedLogEl.textContent || '') + '\n获取 CSV 结果失败: ' + err.message;
            }
          });
      });
    })();

    // 选择子目录后填充「章节压缩包目录」
    document.getElementById('dir_list').addEventListener('change', function() {
      var base = document.getElementById('base_path').value.trim();
      var choiceVal = this.value;
      var rel = choiceVal;
      var dl = document.getElementById('dir_list_datalist');
      if (dl && choiceVal) {
        var opts = dl.options || [];
        for (var i = 0; i < opts.length; i++) {
          if (opts[i].value === choiceVal && opts[i].dataset && opts[i].dataset.rel) {
            rel = opts[i].dataset.rel;
            break;
          }
        }
      }
      // 将输入框中的值也同步成真实相对路径，避免后续困惑
      this.value = rel;

      if (!rel) { document.getElementById('edit_dir').value = ''; return; }
      if (!base) { document.getElementById('edit_dir').value = rel; return; }
      var sep = base.endsWith('/') ? '' : '/';
      document.getElementById('edit_dir').value = base + sep + rel;
    });
    // 导入前同步「包含表头」
    document.getElementById('import-form').addEventListener('submit', function() {
      var cb = document.getElementById('include_header');
      document.getElementById('import_include_header').value = cb && cb.checked ? 'true' : 'false';
    });
    // 导出前把当前 CSV 编辑区内容和章节目录填入表单，避免下载为空，并用于生成文件名
    document.getElementById('export-form').addEventListener('submit', function() {
      if (window.csvEditor && window.csvEditor.sync) window.csvEditor.sync();
      var csvEl = document.getElementById('csv_text');
      document.getElementById('export_csv_hidden').value = csvEl ? csvEl.value : '';
      var cb = document.getElementById('include_header');
      document.getElementById('export_include_header').value = cb && cb.checked ? 'true' : 'false';
      var editDirEl = document.getElementById('edit_dir');
      document.getElementById('export_comic_dir').value = editDirEl ? (editDirEl.value || '') : '';
    });

    // 批量改名
    (function() {
      var RULE_KEY = 'mangatag_rename_rule';
      var WS_CHAR_KEY = 'mangatag_rename_ws_char';
      var WS_ENABLE_KEY = 'mangatag_rename_ws_enable';
      var CONFLICT_KEY = 'mangatag_rename_conflict';

      var btn = document.getElementById('batch-rename-btn');
      var modal = document.getElementById('batch-rename-modal');
      if (!btn || !modal) return;

      function loadOptions() {
        try {
          var rule = localStorage.getItem(RULE_KEY);
          if (rule != null) document.getElementById('batch-rename-rule').value = rule;
          var wsChar = localStorage.getItem(WS_CHAR_KEY);
          if (wsChar != null) document.getElementById('batch-rename-ws-char').value = wsChar || '_';
          var wsEnable = localStorage.getItem(WS_ENABLE_KEY);
          if (wsEnable != null) document.getElementById('batch-rename-ws-enable').checked = wsEnable !== '0';
          var conflict = localStorage.getItem(CONFLICT_KEY);
          if (conflict != null) document.getElementById('batch-rename-conflict').value = conflict || 'suffix';
        } catch (e) {}
      }
      function saveOptions() {
        try {
          var ruleEl = document.getElementById('batch-rename-rule');
          var wsCharEl = document.getElementById('batch-rename-ws-char');
          var wsEnableEl = document.getElementById('batch-rename-ws-enable');
          var conflictEl = document.getElementById('batch-rename-conflict');
          if (ruleEl) localStorage.setItem(RULE_KEY, ruleEl.value || '');
          if (wsCharEl) localStorage.setItem(WS_CHAR_KEY, wsCharEl.value || '_');
          if (wsEnableEl) localStorage.setItem(WS_ENABLE_KEY, wsEnableEl.checked ? '1' : '0');
          if (conflictEl) localStorage.setItem(CONFLICT_KEY, conflictEl.value || 'suffix');
        } catch (e) {}
      }

      var PLACEHOLDER_DESCRIPTIONS = {
        'FileName': '原文件名',
        'Title': '标题',
        'Series': '系列名称',
        'Number': '期号',
        'Summary': '摘要',
        'Writer': '作者',
        'Genre': '类型',
        'Web': '网址',
        'PublishingStatusTachiyomi': '出版状态',
        'SourceMihon': '来源',
        'PublicationYear': '出版年',
        'PublicationMonth': '出版月'
      };
      var NUMBER_COLS = ['Number', 'PublicationYear', 'PublicationMonth'];

      function getHeadersFromTable() {
        var ths = document.querySelectorAll('#csv-data-table thead th');
        if (!ths || ths.length === 0) return null;
        var h = [];
        for (var i = 0; i < ths.length; i++) h.push((ths[i].textContent || '').trim());
        return h;
      }

      function buildPlaceholderList() {
        var headers = getHeadersFromTable();
        if (!headers || headers.length === 0) {
          headers = ['FileName', 'Title', 'Series', 'Number', 'Summary', 'Writer', 'Genre', 'Web', 'PublishingStatusTachiyomi', 'SourceMihon', 'PublicationYear', 'PublicationMonth'];
        }
        var listEl = document.getElementById('batch-rename-placeholder-list');
        var popover = document.getElementById('batch-rename-placeholder-popover');
        if (!listEl || !popover) return;
        listEl.innerHTML = '';
        headers.forEach(function(name) {
          if (!name) return;
          var desc = PLACEHOLDER_DESCRIPTIONS[name] || name;
          var item = document.createElement('div');
          item.className = 'batch-rename-placeholder-item';
          var simple = document.createElement('button');
          simple.type = 'button';
          simple.className = 'batch-rename-placeholder-tag';
          simple.textContent = '{' + name + '}';
          simple.title = desc + ' - 点击插入';
          simple.dataset.placeholder = '{' + name + '}';
          simple.addEventListener('click', function() {
            insertPlaceholder(this.dataset.placeholder);
          });
          item.appendChild(simple);
          if (NUMBER_COLS.indexOf(name) >= 0) {
            var withNum = document.createElement('button');
            withNum.type = 'button';
            withNum.className = 'batch-rename-placeholder-tag batch-rename-placeholder-tag-num';
            withNum.textContent = '{' + name + ':N}';
            withNum.title = desc + ' 补零 - 点击插入';
            withNum.dataset.placeholder = '{' + name + ':3}';
            withNum.addEventListener('click', function() {
              insertPlaceholder(this.dataset.placeholder);
            });
            item.appendChild(withNum);
          }
          var span = document.createElement('span');
          span.className = 'batch-rename-placeholder-desc';
          span.textContent = desc;
          item.appendChild(span);
          listEl.appendChild(item);
        });
      }

      function insertPlaceholder(text) {
        var ruleEl = document.getElementById('batch-rename-rule');
        if (!ruleEl) return;
        var start = ruleEl.selectionStart || 0;
        var end = ruleEl.selectionEnd || ruleEl.value.length;
        var val = ruleEl.value;
        ruleEl.value = val.slice(0, start) + text + val.slice(end);
        ruleEl.selectionStart = ruleEl.selectionEnd = start + text.length;
        ruleEl.focus();
        if (placeholderPopover) placeholderPopover.classList.remove('open');
      }

      var placeholderBtn = document.getElementById('batch-rename-placeholder-btn');
      var placeholderPopover = document.getElementById('batch-rename-placeholder-popover');
      if (placeholderBtn && placeholderPopover) {
        placeholderBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          var isOpen = placeholderPopover.classList.contains('open');
          if (isOpen) {
            placeholderPopover.classList.remove('open');
          } else {
            buildPlaceholderList();
            placeholderPopover.classList.add('open');
          }
        });
        document.addEventListener('click', function(e) {
          if (!placeholderPopover.contains(e.target) && e.target !== placeholderBtn) {
            placeholderPopover.classList.remove('open');
          }
        });
      }

      btn.addEventListener('click', function() {
        if (window.csvEditor && window.csvEditor.sync) window.csvEditor.sync();
        var tokenEl = document.getElementById('scan_token');
        if (!tokenEl || !tokenEl.value) {
          alert('请先扫描目录');
          return;
        }
        loadOptions();
        buildPlaceholderList();
        if (placeholderPopover) placeholderPopover.classList.remove('open');
        modal.classList.add('open');
        document.getElementById('batch-rename-preview').innerHTML = '';
      });

      var previewBtn = document.getElementById('batch-rename-preview-btn');
      var previewEl = document.getElementById('batch-rename-preview');
      if (previewBtn && previewEl) {
        previewBtn.addEventListener('click', function() {
          if (window.csvEditor && window.csvEditor.sync) window.csvEditor.sync();
          var ruleEl = document.getElementById('batch-rename-rule');
          var rule = ruleEl ? ruleEl.value.trim() : '';
          if (!rule) {
            previewEl.innerHTML = '<span class="batch-rename-preview-err">请输入命名规则</span>';
            return;
          }
          var csvEl = document.getElementById('csv_text');
          var includeCb = document.getElementById('include_header');
          var tokenEl = document.getElementById('scan_token');
          var wsEnableEl = document.getElementById('batch-rename-ws-enable');
          var wsCharEl = document.getElementById('batch-rename-ws-char');
          var conflictEl = document.getElementById('batch-rename-conflict');
          var payload = {
            csv_text: csvEl ? csvEl.value : '',
            include_header: includeCb && includeCb.checked ? 'true' : 'false',
            scan_token: tokenEl ? tokenEl.value : '',
            rule: rule,
            ws_replace_enabled: wsEnableEl && wsEnableEl.checked,
            ws_replace_char: wsCharEl ? (wsCharEl.value || '_') : '_',
            conflict_mode: conflictEl ? conflictEl.value : 'suffix'
          };
          previewEl.innerHTML = '<span class="batch-rename-preview-loading">预览中…</span>';
          previewBtn.disabled = true;
          fetch('/batch-rename-preview', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
            .then(function(res) { return res.json(); })
            .then(function(data) {
              if (data && data.ok && data.preview && data.preview.length > 0) {
                var html = '<table class="batch-rename-preview-table"><thead><tr><th>原文件名</th><th>→</th><th>新文件名</th></tr></thead><tbody>';
                data.preview.forEach(function(p) {
                  html += '<tr><td>' + escapeHtml(p[0]) + '</td><td>→</td><td>' + escapeHtml(p[1]) + '</td></tr>';
                });
                html += '</tbody></table><div class="batch-rename-preview-count">共 ' + data.preview.length + ' 个文件</div>';
                previewEl.innerHTML = html;
              } else if (data && data.ok && data.preview && data.preview.length === 0) {
                previewEl.innerHTML = '<span class="batch-rename-preview-err">无匹配项</span>';
              } else {
                previewEl.innerHTML = '<span class="batch-rename-preview-err">' + escapeHtml(data.error || '预览失败') + '</span>';
              }
            })
            .catch(function(err) {
              previewEl.innerHTML = '<span class="batch-rename-preview-err">请求失败: ' + escapeHtml(err && err.message || '未知错误') + '</span>';
            })
            .finally(function() {
              previewBtn.disabled = false;
            });
        });
      }
      function escapeHtml(s) {
        if (s == null) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      var closeBtn = document.getElementById('batch-rename-close-btn');
      if (closeBtn) closeBtn.addEventListener('click', function() { modal.classList.remove('open'); });
      document.querySelector('.batch-rename-cancel').addEventListener('click', function() {
        modal.classList.remove('open');
      });

      document.querySelector('.batch-rename-confirm').addEventListener('click', function() {
        if (window.csvEditor && window.csvEditor.sync) window.csvEditor.sync();
        var ruleEl = document.getElementById('batch-rename-rule');
        var rule = ruleEl ? ruleEl.value.trim() : '';
        if (!rule) {
          alert('请输入命名规则');
          return;
        }
        saveOptions();

        var csvEl = document.getElementById('csv_text');
        var includeCb = document.getElementById('include_header');
        var tokenEl = document.getElementById('scan_token');
        var wsEnableEl = document.getElementById('batch-rename-ws-enable');
        var wsCharEl = document.getElementById('batch-rename-ws-char');
        var conflictEl = document.getElementById('batch-rename-conflict');

        var payload = {
          csv_text: csvEl ? csvEl.value : '',
          include_header: includeCb && includeCb.checked ? 'true' : 'false',
          scan_token: tokenEl ? tokenEl.value : '',
          rule: rule,
          ws_replace_enabled: wsEnableEl && wsEnableEl.checked,
          ws_replace_char: wsCharEl ? (wsCharEl.value || '_') : '_',
          conflict_mode: conflictEl ? conflictEl.value : 'suffix'
        };

        var confirmBtn = document.querySelector('.batch-rename-confirm');
        if (confirmBtn) confirmBtn.disabled = true;

        fetch('/batch-rename', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data && data.ok) {
              var ta = document.getElementById('csv_text');
              if (ta) ta.value = data.csv_text || '';
              if (window.csvEditor && window.csvEditor.render) {
                window.csvEditor.render('csv-table-wrap', data.csv_text || '');
              }
              var logEl = document.getElementById('unified-log');
              if (logEl) {
                if (logEl.textContent) logEl.textContent += '\n\n--- 批量改名 ---\n';
                logEl.textContent += (data.log || '') + '\n';
              }
              modal.classList.remove('open');
            } else {
              alert(data.error || data.log || '批量改名失败');
            }
          })
          .catch(function(err) {
            alert('请求失败: ' + (err && err.message || '未知错误'));
          })
          .finally(function() {
            if (confirmBtn) confirmBtn.disabled = false;
          });
      });
    })();

    // 保存：流式请求 /save-stream，逐条追加到保存日志
    document.getElementById('save-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var form = this;
      var unifiedLogEl = document.getElementById('unified-log');
      var saveBtn = document.getElementById('save-btn');
      var saveIndicator = document.getElementById('save-indicator');
      if (!unifiedLogEl || !saveBtn) return;

      // 同步表单隐藏域（表格 -> csv_text -> 隐藏域）
      if (window.csvEditor && window.csvEditor.sync) window.csvEditor.sync();
      var csvEl = document.getElementById('csv_text');
      document.getElementById('save_csv_hidden').value = csvEl ? csvEl.value : '';
      var cb = document.getElementById('include_header');
      document.getElementById('save_include_header').value = cb && cb.checked ? 'true' : 'false';
      var checkCb = document.getElementById('check_count');
      document.getElementById('save_check_count').value = checkCb && checkCb.checked ? 'true' : 'false';

      if (unifiedLogEl.textContent) unifiedLogEl.textContent += '\n\n--- 保存 ---\n';
      form.classList.add('saving');
      if (saveIndicator) saveIndicator.style.display = 'inline';

      // 为避免 multipart 单字段 1MB 限制，这里以 JSON 形式提交到 /save-stream
      var payload = {
        csv_text: document.getElementById('save_csv_hidden').value || '',
        include_header: document.getElementById('save_include_header').value || 'true',
        check_count: document.getElementById('save_check_count').value || 'true',
        scan_token: document.getElementById('scan_token').value || ''
      };

      fetch('/save-stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(function(res) {
          if (!res.body) return;
          var reader = res.body.getReader();
          var decoder = new TextDecoder();

          function read() {
            return reader.read().then(function(opt) {
              if (opt.done) return;
              var text = decoder.decode(opt.value, { stream: true });
              unifiedLogEl.textContent += text;
              return read();
            });
          }

          return read();
        })
        .catch(function(err) {
          unifiedLogEl.textContent = (unifiedLogEl.textContent || '') + '\n请求失败: ' + err.message;
        })
        .finally(function() {
          form.classList.remove('saving');
          if (saveIndicator) saveIndicator.style.display = 'none';
        });
    });

    // 日志栏：收起/展开、调节宽度
    (function() {
      var panel = document.getElementById('log-panel');
      var toggleBtn = document.getElementById('log-panel-toggle');
      var resizeHandle = document.getElementById('log-resize-handle');
      if (!panel || !toggleBtn || !resizeHandle) return;

      var STORAGE_KEY = 'mangatag_log_panel';
      var DEFAULT_WIDTH = 320;
      var MIN_WIDTH = 200;
      var MAX_WIDTH_PX = Math.min(800, window.innerWidth * 0.8);

      function loadState() {
        try {
          var s = localStorage.getItem(STORAGE_KEY);
          if (s) {
            var d = JSON.parse(s);
            if (d.collapsed) panel.classList.add('collapsed');
            if (typeof d.width === 'number' && d.width >= MIN_WIDTH) {
              panel.style.setProperty('--log-panel-width', d.width + 'px');
            }
          }
        } catch (e) {}
      }
      function saveState() {
        try {
          var collapsed = panel.classList.contains('collapsed');
          var w = parseInt(getComputedStyle(panel).width, 10) || DEFAULT_WIDTH;
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ collapsed: collapsed, width: w }));
        } catch (e) {}
      }

      toggleBtn.addEventListener('click', function() {
        panel.classList.toggle('collapsed');
        saveState();
      });

      var startX, startW;
      resizeHandle.addEventListener('mousedown', function(e) {
        if (panel.classList.contains('collapsed')) return;
        e.preventDefault();
        startX = e.clientX;
        startW = panel.offsetWidth;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        function onMove(e) {
          var dx = e.clientX - startX;
          var newW = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH_PX, startW - dx));
          panel.style.setProperty('--log-panel-width', newW + 'px');
        }
        function onUp() {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
          saveState();
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });

      loadState();
    })();
  </script>
</body>
</html>
