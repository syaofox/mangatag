<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MangaTag - ç¼–è¾‘å‹ç¼©åŒ…å†… XML</title>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script>htmx.config.allowScriptTags = true;</script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: #fff; color: #333; margin: 0; padding: 1rem 2rem; line-height: 1.5; }
    h1 { font-size: 1.25rem; margin-bottom: 0.5rem; }
    .subtitle { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
    label { display: block; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #555; }
    input[type="text"], select, textarea { width: 100%; max-width: 640px; padding: 0.5rem; background: #fff; border: 1px solid #ccc; border-radius: 4px; color: #333; }
    textarea { min-height: 120px; font-family: ui-monospace, monospace; font-size: 0.875rem; }
    #csv-area textarea { min-height: 280px; max-width: none; width: 100%; white-space: pre; overflow-x: auto; }
    .csv-table-container { overflow: auto; max-height: 400px; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.25rem; }
    .csv-table { border-collapse: collapse; font-size: 0.85rem; width: max-content; min-width: 100%; table-layout: auto; }
    .csv-table th, .csv-table td { border: 1px solid #ddd; padding: 0.25rem 0.4rem; text-align: left; white-space: nowrap; }
    .csv-table th { background: #f0f0f0; font-weight: 600; position: sticky; top: 0; }
    .csv-table td input { width: auto; min-width: 4em; border: none; padding: 0.2rem; background: transparent; font: inherit; box-sizing: border-box; }
    .csv-table td input:focus { outline: 1px solid #0066cc; background: #fff; }
    button, .btn { display: inline-block; padding: 0.5rem 1rem; background: #0066cc; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-right: 0.5rem; margin-top: 0.5rem; }
    button:hover, .btn:hover { background: #0052a3; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
    .col { flex: 1; min-width: 200px; }
    .log { white-space: pre-wrap; font-family: ui-monospace, monospace; font-size: 0.8rem; background: #f5f5f5; padding: 0.75rem; border-radius: 4px; min-height: 80px; border: 1px solid #ddd; }
    .accordion { border: 1px solid #ccc; border-radius: 4px; background: #fafafa; }
    .accordion summary { padding: 0.5rem 1rem; cursor: pointer; }
    .accordion .body { padding: 1rem; border-top: 1px solid #ccc; }
    .batch-cols-label { display: inline-block; margin-right: 0.5rem; vertical-align: top; color: #555; }
    .batch-cols-checkboxes { display: flex; flex-wrap: wrap; gap: 0.5rem 1.5rem; align-items: center; }
    .batch-cols-option { display: inline-flex; align-items: center; gap: 0.25rem; cursor: pointer; white-space: nowrap; }
    a.btn, a#export-btn { color: #fff; text-decoration: none; }
    .htmx-request .htmx-indicator { display: inline; }
    .htmx-indicator { display: none; }
    /* è¯·æ±‚è¿›è¡Œä¸­ç¦ç”¨æŒ‰é’®ï¼Œé¿å…é‡å¤æäº¤å¯¼è‡´æ—¥å¿—ä¸æ“ä½œé”™ä½ */
    #scan-btn.htmx-request { pointer-events: none; opacity: 0.7; }
    #save-form.saving #save-btn { pointer-events: none; opacity: 0.7; }
    .path-with-browse { display: flex; gap: 0.5rem; align-items: center; max-width: 640px; }
    .path-with-browse input { flex: 1; min-width: 0; }
    .path-with-browse .btn { flex-shrink: 0; margin-top: 0; }
    /* å¸ƒå±€ä½“ç³» */
    .section { margin-bottom: 1.25rem; }
    .section-title { font-size: 0.9rem; font-weight: 600; color: #444; margin-bottom: 0.5rem; }
    .form-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
    .form-row .control-group { display: flex; align-items: center; gap: 0.5rem; }
    .form-row .control-group label { margin: 0; display: inline-flex; align-items: center; gap: 0.25rem; }
    .control-group { margin-bottom: 0.5rem; }
    .control-group label { margin-bottom: 0.25rem; }
    .batch-group { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e8e8e8; }
    .batch-group:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
    .batch-group-title { font-size: 0.85rem; color: #555; margin-bottom: 0.5rem; }
    .save-section { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; }
    .btn-primary { background: #0066cc; font-weight: 500; }
    .btn-primary:hover { background: #0052a3; }
    #browse-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; }
    #browse-modal.open { display: flex; }
    #browse-modal .dialog { background: #fff; border-radius: 8px; padding: 1.25rem; min-width: 360px; max-width: 90vw; max-height: 70vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    #browse-modal .dialog h3 { margin: 0 0 0.75rem; font-size: 1rem; }
    #browse-modal .current-path { font-size: 0.85rem; color: #555; word-break: break-all; margin-bottom: 0.75rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px; }
    #browse-modal .folder-list { overflow-y: auto; max-height: 280px; border: 1px solid #ddd; border-radius: 4px; padding: 0.25rem; }
    #browse-modal .folder-item { display: block; width: 100%; padding: 0.5rem 0.75rem; text-align: left; border: none; background: none; cursor: pointer; border-radius: 4px; font-size: 0.95rem; color: #333; }
    #browse-modal .folder-item:hover { background: #e8f0fe; }
    #browse-modal .folder-item::before { content: "ğŸ“ "; }
    #browse-modal .folder-item.parent::before { content: "â¬† "; }
    #browse-modal .actions { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
  </style>
</head>
<body>
  <h1>ç¼–è¾‘å‹ç¼©åŒ…å†… XML</h1>
  <p class="subtitle">æ‰«æç›®å½•ä¸­çš„ .cbz/.zipï¼Œè¯»å– ComicInfo.xml ååœ¨ä¸‹æ–¹ CSV ä¸­ç¼–è¾‘å¹¶ä¿å­˜å›å‹ç¼©åŒ…ã€‚ç¬¬ä¸€åˆ—ä¸º FileNameï¼ˆå›ºå®šï¼‰ï¼Œå…¶ä½™åˆ—ä¸ºå…ƒæ•°æ®ã€‚</p>

  <section class="section">
    <h2 class="section-title">ç›®å½•é€‰æ‹©</h2>
    <form id="dir-form">
      <div class="control-group">
        <label for="base_path">åŸºè·¯å¾„</label>
        <div class="path-with-browse">
          <input type="text" id="base_path" name="base_path" value="{{ default_base_path }}" placeholder="å¦‚ /home/user/outputs" />
          <button type="button" id="browse-btn" class="btn" title="æµè§ˆæ–‡ä»¶å¤¹">æµè§ˆ</button>
        </div>
      </div>
      <div class="control-group">
        <label for="dir_list">æ¼«ç”»æ–‡ä»¶å¤¹</label>
        <div class="form-row" style="align-items: center;">
          <button type="button" id="refresh-dirs"
            hx-get="/api/dirs"
            hx-include="#base_path"
            hx-target="#dir_list"
            hx-swap="innerHTML"
            hx-trigger="click">åˆ·æ–°</button>
          <span class="htmx-indicator">åŠ è½½ä¸­â€¦</span>
          <select id="dir_list" name="dir_list" style="min-width: 200px; max-width: 400px;">
            <option value="">-- é€‰æ‹© --</option>
          </select>
        </div>
      </div>
      <div class="control-group">
        <label for="edit_dir">ç« èŠ‚å‹ç¼©åŒ…ç›®å½•</label>
        <input type="text" id="edit_dir" name="comic_dir" placeholder="å¦‚ /path/to/comic/dir" style="max-width: 640px;" />
      </div>
    </form>
  </section>

  <section class="section">
    <h2 class="section-title">æ‰«æé€‰é¡¹</h2>
    <div class="form-row">
      <label class="control-group" style="display: inline-flex; align-items: center; margin: 0;">
        <input type="checkbox" id="include_header" name="include_header" checked /> åŒ…å«è¡¨å¤´
      </label>
      <div class="control-group" style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
        <label for="sort_mode" style="margin: 0;">æ’åº</label>
        <select id="sort_mode" name="sort_mode" style="max-width: 180px;">
          {% for opt in sort_choices %}
          <option value="{{ opt }}" {% if opt == "æŒ‰æ•°å­—å¤§å°é¡ºåº" %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="button" id="scan-btn" class="btn btn-primary"
        hx-post="/scan"
        hx-include="#edit_dir, #include_header, #sort_mode"
        hx-target="body"
        hx-swap="none"
        hx-trigger="click"
        hx-on::click="var sl=document.getElementById('scan-log'); var sv=document.getElementById('save-log'); if(sl){sl.innerHTML='';} if(sv){sv.innerHTML='';} if(sl){sl.innerHTML='æ‰«æä¸­â€¦';}"
        >æ‰«æç›®å½•å¹¶è¯»å– ComicInfo.xml</button>
      <span class="htmx-indicator">æ‰«æä¸­â€¦</span>
    </div>
  </section>

  <section class="section">
    <div id="scan-log-wrap">
      <label>æ‰«ææ—¥å¿—</label>
      <div id="scan-log" class="log">{{ scan_log }}</div>
    </div>
  </section>

  <section class="section">
  <div id="csv-area">
    {% include "partials/csv_editor.html" %}
  </div>
  </section>

  <section class="section">
  <details class="accordion">
    <summary>æ‰¹é‡ç¼–è¾‘</summary>
    <div class="body">
      <div class="batch-group">
        <div class="batch-group-title">ç¹ç®€è½¬æ¢</div>
        <div class="form-row">
          <button type="button" id="batch-t2s-all"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
            hx-vals='{"action": "t2s"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">å…¨éƒ¨åˆ—ï¼šç¹ä½“è½¬ç®€ä½“ï¼ˆé™¤ FileNameï¼‰</button>
          <button type="button" id="batch-s2t-all"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
            hx-vals='{"action": "s2t"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">å…¨éƒ¨åˆ—ï¼šç®€ä½“è½¬ç¹ä½“ï¼ˆé™¤ FileNameï¼‰</button>
        </div>
        <div class="form-row" style="margin-top: 0.5rem;">
          <button type="button" id="batch-t2s-cols"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
            hx-vals='{"action": "t2s"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">æ‰€é€‰åˆ—ï¼šç¹ä½“è½¬ç®€ä½“</button>
          <button type="button" id="batch-s2t-cols"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
            hx-vals='{"action": "s2t"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">æ‰€é€‰åˆ—ï¼šç®€ä½“è½¬ç¹ä½“</button>
        </div>
      </div>
      <div class="batch-group">
        <div class="batch-group-title">é€‰æ‹©æ‰¹é‡ç¼–è¾‘åˆ—</div>
        <div id="batch_columns" class="batch-cols-checkboxes">
          {% for h in csv_headers %}
          {% if h != "FileName" %}
          <label class="batch-cols-option"><input type="checkbox" name="columns" value="{{ h }}" /> {{ h }}</label>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      <div class="batch-group">
        <div class="batch-group-title">æ‰¹é‡ç½®ä¸º</div>
        <div class="form-row">
          <input type="text" id="batch_set_val" name="batch_set_val" placeholder="å€¼" style="max-width: 240px;" />
          <button type="button" id="batch-set-btn"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #batch_set_val"
            hx-vals='{"action": "batch_set"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">æ‰§è¡Œæ‰¹é‡ç½®ä¸º</button>
        </div>
      </div>
      <div class="batch-group">
        <div class="batch-group-title">æŸ¥æ‰¾æ›¿æ¢</div>
        <div class="form-row">
          <input type="text" id="fr_find" name="fr_find" placeholder="æŸ¥æ‰¾å†…å®¹" style="max-width: 200px;" />
          <input type="text" id="fr_replace" name="fr_replace" placeholder="æ›¿æ¢ä¸º" style="max-width: 200px;" />
          <button type="button" id="batch-fr-btn"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #fr_find, #fr_replace"
            hx-vals='{"action": "find_replace"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">æ‰§è¡ŒæŸ¥æ‰¾æ›¿æ¢</button>
        </div>
      </div>
      <div class="batch-group">
        <div class="batch-group-title">å‰åç¼€</div>
        <div class="form-row">
          <input type="text" id="prefix_val" name="prefix_val" placeholder="å‰ç¼€" style="max-width: 120px;" />
          <button type="button" id="batch-prefix-btn"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #prefix_val"
            hx-vals='{"action": "prefix"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">æ·»åŠ å‰ç¼€</button>
          <input type="text" id="suffix_val" name="suffix_val" placeholder="åç¼€" style="max-width: 120px; margin-left: 0.5rem;" />
          <button type="button" id="batch-suffix-btn"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #suffix_val"
            hx-vals='{"action": "suffix"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">æ·»åŠ åç¼€</button>
        </div>
      </div>
    </div>
  </details>
  </section>

  <section class="section">
    <details class="accordion" open>
      <summary>ä¸‹è½½ / å¯¼å…¥</summary>
      <div class="body">
        <div class="form-row">
          <form id="export-form" method="POST" action="/export" target="_blank" style="display: inline-flex; align-items: center;">
            <input type="hidden" name="csv_text" id="export_csv_hidden" value="" />
            <input type="hidden" name="include_header" id="export_include_header" value="true" />
            <button type="submit" class="btn" id="export-btn">ä¸‹è½½ CSV</button>
          </form>
          <form id="import-form" hx-post="/import" hx-target="#csv-area" hx-swap="outerHTML" hx-encoding="multipart/form-data" class="form-row">
            <input type="hidden" name="include_header" id="import_include_header" value="true" />
            <label for="import_file" style="margin: 0;">å¯¼å…¥ CSV</label>
            <input type="file" id="import_file" name="import_file" accept=".csv" required />
            <button type="submit" id="import-btn">å¯¼å…¥</button>
          </form>
        </div>
      </div>
    </details>
  </section>

  <section class="section save-section">
    <label style="display: inline-flex; align-items: center; margin: 0;">
      <input type="checkbox" id="check_count" name="check_count" checked /> æ£€æµ‹æ–‡æ¡£æ•°é‡ä¸€è‡´ï¼ˆCSV ä¸æ‰«ææ•°é‡éœ€ä¸€è‡´ï¼‰
    </label>
    <form id="save-form" style="display: inline;">
      <input type="hidden" name="scan_token" id="scan_token" value="" />
      <input type="hidden" name="csv_text" id="save_csv_hidden" value="" />
      <input type="hidden" name="include_header" id="save_include_header" value="true" />
      <input type="hidden" name="check_count" id="save_check_count" value="true" />
      <button type="submit" id="save-btn" class="btn btn-primary">ä¿å­˜ä¿®æ”¹åˆ°å‹ç¼©åŒ…</button>
    </form>
    <span id="save-indicator" class="htmx-indicator" style="display: none;">ä¿å­˜ä¸­â€¦</span>
  </section>

  <section class="section">
    <div id="save-log-wrap">
      <label>ä¿å­˜æ—¥å¿—</label>
      <div id="save-log" class="log">{{ save_log }}</div>
    </div>
  </section>

  <div id="browse-modal" role="dialog" aria-label="æµè§ˆæ–‡ä»¶å¤¹">
    <div class="dialog">
      <h3>é€‰æ‹©åŸºè·¯å¾„ç›®å½•</h3>
      <div id="browse-current" class="current-path">/</div>
      <div id="browse-list" class="folder-list"></div>
      <div class="actions">
        <button type="button" id="browse-cancel" class="btn" style="background: #666;">å–æ¶ˆ</button>
        <button type="button" id="browse-select" class="btn">é€‰æ‹©æ­¤ç›®å½•</button>
      </div>
    </div>
  </div>

  <script>
    // æµè§ˆæ–‡ä»¶å¤¹
    (function() {
      var modal = document.getElementById('browse-modal');
      var currentEl = document.getElementById('browse-current');
      var listEl = document.getElementById('browse-list');
      var browseBtn = document.getElementById('browse-btn');
      var cancelBtn = document.getElementById('browse-cancel');
      var selectBtn = document.getElementById('browse-select');
      var basePathInput = document.getElementById('base_path');
      var currentPath = '';

      function loadBrowse(path) {
        var url = '/api/browse' + (path ? '?path=' + encodeURIComponent(path) : '');
        fetch(url).then(function(r) {
          if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || 'åŠ è½½å¤±è´¥'); });
          return r.json();
        }).then(function(data) {
          currentPath = data.current;
          currentEl.textContent = data.current || '/';
          listEl.innerHTML = '';
          if (data.parent) {
            var parentBtn = document.createElement('button');
            parentBtn.type = 'button';
            parentBtn.className = 'folder-item parent';
            parentBtn.textContent = 'ä¸Šä¸€çº§';
            parentBtn.dataset.path = data.parent;
            parentBtn.addEventListener('click', function() { loadBrowse(data.parent); });
            listEl.appendChild(parentBtn);
          }
          data.entries.forEach(function(e) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'folder-item';
            btn.textContent = e.name;
            btn.dataset.path = e.path;
            btn.addEventListener('click', function() { loadBrowse(e.path); });
            listEl.appendChild(btn);
          });
        }).catch(function(err) {
          currentEl.textContent = 'é”™è¯¯: ' + err.message;
          listEl.innerHTML = '';
        });
      }

      browseBtn.addEventListener('click', function() {
        var start = basePathInput.value.trim();
        modal.classList.add('open');
        loadBrowse(start || undefined);
      });
      cancelBtn.addEventListener('click', function() { modal.classList.remove('open'); });
      selectBtn.addEventListener('click', function() {
        if (currentPath) basePathInput.value = currentPath;
        modal.classList.remove('open');
      });
      modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.classList.remove('open');
      });
    })();

    // å¯¼å…¥/æ‰«æ/æ‰¹é‡ç¼–è¾‘åï¼Œè‹¥ #csv-area è¢«æ›¿æ¢ï¼Œéœ€æ‰‹åŠ¨æ¸²æŸ“è¡¨æ ¼ï¼ˆallowScriptTags å¯èƒ½ä»ä¸æ‰§è¡Œï¼Œæ­¤ä½œä¸ºåå¤‡ï¼‰
    function maybeRenderCsvTable() {
      var dataEl = document.getElementById('csv-initial-data');
      var wrap = document.getElementById('csv-table-wrap');
      if (!dataEl || !wrap) return;
      var csv = '';
      try {
        csv = (dataEl.textContent && dataEl.textContent.trim()) ? JSON.parse(dataEl.textContent) : '';
      } catch (e) { return; }
      var ta = document.getElementById('csv_text');
      if (ta) ta.value = csv;
      if (window.csvEditor && window.csvEditor.render) window.csvEditor.render('csv-table-wrap', csv);
    }
    document.body.addEventListener('htmx:afterSwap', function(ev) {
      if (ev.detail && ev.detail.target && (ev.detail.target.id === 'csv-area' || (ev.detail.target.querySelector && ev.detail.target.querySelector('#csv-initial-data')))) maybeRenderCsvTable();
    });
    document.body.addEventListener('htmx:afterSettle', function() {
      if (document.getElementById('csv-initial-data') && !document.getElementById('csv-data-table')) {
        setTimeout(maybeRenderCsvTable, 0);
      }
    });

    // é€‰æ‹©å­ç›®å½•åå¡«å……ã€Œç« èŠ‚å‹ç¼©åŒ…ç›®å½•ã€
    document.getElementById('dir_list').addEventListener('change', function() {
      var base = document.getElementById('base_path').value.trim();
      var choice = this.value;
      if (!choice) { document.getElementById('edit_dir').value = ''; return; }
      if (!base) { document.getElementById('edit_dir').value = choice; return; }
      var sep = base.endsWith('/') ? '' : '/';
      document.getElementById('edit_dir').value = base + sep + choice;
    });
    // å¯¼å…¥å‰åŒæ­¥ã€ŒåŒ…å«è¡¨å¤´ã€
    document.getElementById('import-form').addEventListener('submit', function() {
      var cb = document.getElementById('include_header');
      document.getElementById('import_include_header').value = cb && cb.checked ? 'true' : 'false';
    });
    // å¯¼å‡ºå‰æŠŠå½“å‰ CSV ç¼–è¾‘åŒºå†…å®¹å¡«å…¥è¡¨å•ï¼Œé¿å…ä¸‹è½½ä¸ºç©º
    document.getElementById('export-form').addEventListener('submit', function() {
      if (window.csvEditor && window.csvEditor.sync) window.csvEditor.sync();
      var csvEl = document.getElementById('csv_text');
      document.getElementById('export_csv_hidden').value = csvEl ? csvEl.value : '';
      var cb = document.getElementById('include_header');
      document.getElementById('export_include_header').value = cb && cb.checked ? 'true' : 'false';
    });
    // ä¿å­˜ï¼šæµå¼è¯·æ±‚ /save-streamï¼Œé€æ¡è¿½åŠ åˆ°ä¿å­˜æ—¥å¿—
    document.getElementById('save-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var form = this;
      var saveLogEl = document.getElementById('save-log');
      var saveBtn = document.getElementById('save-btn');
      var saveIndicator = document.getElementById('save-indicator');
      if (!saveLogEl || !saveBtn) return;

      // åŒæ­¥è¡¨å•éšè—åŸŸï¼ˆè¡¨æ ¼ -> csv_text -> éšè—åŸŸï¼‰
      if (window.csvEditor && window.csvEditor.sync) window.csvEditor.sync();
      var csvEl = document.getElementById('csv_text');
      document.getElementById('save_csv_hidden').value = csvEl ? csvEl.value : '';
      var cb = document.getElementById('include_header');
      document.getElementById('save_include_header').value = cb && cb.checked ? 'true' : 'false';
      var checkCb = document.getElementById('check_count');
      document.getElementById('save_check_count').value = checkCb && checkCb.checked ? 'true' : 'false';

      saveLogEl.textContent = '';
      form.classList.add('saving');
      if (saveIndicator) saveIndicator.style.display = 'inline';

      var formData = new FormData(form);
      fetch('/save-stream', { method: 'POST', body: formData })
        .then(function(res) {
          if (!res.body) return;
          var reader = res.body.getReader();
          var decoder = new TextDecoder();
          function read() {
            return reader.read().then(function(opt) {
              if (opt.done) return;
              var text = decoder.decode(opt.value, { stream: true });
              saveLogEl.textContent += text;
              return read();
            });
          }
          return read();
        })
        .catch(function(err) {
          saveLogEl.textContent = (saveLogEl.textContent || '') + '\nè¯·æ±‚å¤±è´¥: ' + err.message;
        })
        .finally(function() {
          form.classList.remove('saving');
          if (saveIndicator) saveIndicator.style.display = 'none';
        });
    });
  </script>
</body>
</html>
