<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MangaTag - 编辑压缩包内 XML</title>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: #fff; color: #333; margin: 0; padding: 1rem 2rem; line-height: 1.5; }
    h1 { font-size: 1.25rem; margin-bottom: 0.5rem; }
    .subtitle { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
    label { display: block; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #555; }
    input[type="text"], select, textarea { width: 100%; max-width: 640px; padding: 0.5rem; background: #fff; border: 1px solid #ccc; border-radius: 4px; color: #333; }
    textarea { min-height: 120px; font-family: ui-monospace, monospace; font-size: 0.875rem; }
    #csv-area textarea { min-height: 280px; max-width: none; width: 100%; }
    button, .btn { display: inline-block; padding: 0.5rem 1rem; background: #0066cc; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-right: 0.5rem; margin-top: 0.5rem; }
    button:hover, .btn:hover { background: #0052a3; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
    .col { flex: 1; min-width: 200px; }
    .log { white-space: pre-wrap; font-family: ui-monospace, monospace; font-size: 0.8rem; background: #f5f5f5; padding: 0.75rem; border-radius: 4px; min-height: 80px; border: 1px solid #ddd; }
    .accordion { border: 1px solid #ccc; border-radius: 4px; margin-top: 1rem; background: #fafafa; }
    .accordion summary { padding: 0.5rem 1rem; cursor: pointer; }
    .accordion .body { padding: 1rem; border-top: 1px solid #ccc; }
    .batch-cols-label { display: inline-block; margin-right: 0.5rem; vertical-align: top; color: #555; }
    .batch-cols-checkboxes { display: flex; flex-wrap: wrap; gap: 0.5rem 1.5rem; align-items: center; }
    .batch-cols-option { display: inline-flex; align-items: center; gap: 0.25rem; cursor: pointer; white-space: nowrap; }
    a.btn, a#export-btn { color: #fff; text-decoration: none; }
    .htmx-request .htmx-indicator { display: inline; }
    .htmx-indicator { display: none; }
  </style>
</head>
<body>
  <h1>编辑压缩包内 XML</h1>
  <p class="subtitle">扫描目录中的 .cbz/.zip，读取 ComicInfo.xml 后在下方 CSV 中编辑并保存回压缩包。第一列为 FileName（固定），其余列为元数据。</p>

  <form id="dir-form" class="row">
    <div class="col">
      <label for="base_path">基路径</label>
      <input type="text" id="base_path" name="base_path" value="{{ default_base_path }}" placeholder="如 /home/user/outputs" />
    </div>
    <div class="col">
      <button type="button" id="refresh-dirs"
        hx-get="/api/dirs"
        hx-include="#base_path"
        hx-target="#dir_list"
        hx-swap="innerHTML"
        hx-trigger="click">刷新</button>
      <span class="htmx-indicator">加载中…</span>
    </div>
    <div class="col">
      <label for="dir_list">漫画文件夹列表</label>
      <select id="dir_list" name="dir_list">
        <option value="">-- 选择 --</option>
      </select>
    </div>
    <div class="col" style="flex: 2;">
      <label for="edit_dir">章节压缩包目录</label>
      <input type="text" id="edit_dir" name="comic_dir" placeholder="如 /path/to/comic/dir" />
    </div>
  </form>

  <div class="row" style="margin-top: 0.5rem;">
    <label style="display: inline-flex; align-items: center; margin-right: 1rem;">
      <input type="checkbox" id="include_header" name="include_header" checked /> 包含表头
    </label>
    <div style="display: inline-block;">
      <label for="sort_mode" style="display: inline; margin-right: 0.5rem;">排序</label>
      <select id="sort_mode" name="sort_mode">
        {% for opt in sort_choices %}
        <option value="{{ opt }}" {% if opt == "按数字大小顺序" %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </div>
    <span>
      <button type="button" id="scan-btn"
        hx-post="/scan"
        hx-include="#edit_dir, #include_header, #sort_mode"
        hx-target="body"
        hx-swap="none"
        hx-trigger="click"
        hx-on::click="document.getElementById('scan-log').innerHTML=''; document.getElementById('save-log').innerHTML='';"
        >扫描目录并读取 ComicInfo.xml</button>
      <span class="htmx-indicator">扫描中…</span>
    </span>
  </div>

  <div id="scan-log-wrap" style="margin-top: 1rem;">
    <label>扫描日志</label>
    <div id="scan-log" class="log">{{ scan_log }}</div>
  </div>

  <div id="csv-area" style="margin-top: 1rem;">
    <label>CSV 编辑区</label>
    <textarea id="csv_text" name="csv_text" rows="18">{{ csv_text }}</textarea>
  </div>

  <details class="accordion">
    <summary>批量编辑</summary>
    <div class="body">
      <div class="row">
        <button type="button" id="batch-t2s-all"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
          hx-vals='{"action": "t2s"}' hx-target="body" hx-swap="none" hx-trigger="click">全部列：繁体转简体（除 FileName）</button>
        <button type="button" id="batch-s2t-all"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
          hx-vals='{"action": "s2t"}' hx-target="body" hx-swap="none" hx-trigger="click">全部列：简体转繁体（除 FileName）</button>
      </div>
      <div class="row">
        <span class="batch-cols-label">选择批量编辑列</span>
        <div id="batch_columns" class="batch-cols-checkboxes">
          {% for h in csv_headers %}
          {% if h != "FileName" %}
          <label class="batch-cols-option"><input type="checkbox" name="columns" value="{{ h }}" /> {{ h }}</label>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      <div class="row">
        <button type="button" id="batch-t2s-cols"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
          hx-vals='{"action": "t2s"}' hx-target="body" hx-swap="none" hx-trigger="click">所选列：繁体转简体</button>
        <button type="button" id="batch-s2t-cols"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
          hx-vals='{"action": "s2t"}' hx-target="body" hx-swap="none" hx-trigger="click">所选列：简体转繁体</button>
      </div>
      <div class="row">
        <input type="text" id="batch_set_val" name="batch_set_val" placeholder="批量置为：值" style="max-width: 240px;" />
        <button type="button" id="batch-set-btn"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #batch_set_val"
          hx-vals='{"action": "batch_set"}' hx-target="body" hx-swap="none" hx-trigger="click">执行批量置为</button>
      </div>
      <div class="row">
        <input type="text" id="fr_find" name="fr_find" placeholder="查找内容" style="max-width: 200px;" />
        <input type="text" id="fr_replace" name="fr_replace" placeholder="替换为" style="max-width: 200px;" />
        <button type="button" id="batch-fr-btn"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #fr_find, #fr_replace"
          hx-vals='{"action": "find_replace"}' hx-target="body" hx-swap="none" hx-trigger="click">执行查找替换</button>
      </div>
      <div class="row">
        <input type="text" id="prefix_val" name="prefix_val" placeholder="前缀" style="max-width: 120px;" />
        <button type="button" id="batch-prefix-btn"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #prefix_val"
          hx-vals='{"action": "prefix"}' hx-target="body" hx-swap="none" hx-trigger="click">添加前缀</button>
        <input type="text" id="suffix_val" name="suffix_val" placeholder="后缀" style="max-width: 120px;" />
        <button type="button" id="batch-suffix-btn"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #suffix_val"
          hx-vals='{"action": "suffix"}' hx-target="body" hx-swap="none" hx-trigger="click">添加后缀</button>
      </div>
    </div>
  </details>

  <div class="row" style="margin-top: 1rem;">
    <details class="accordion" open>
      <summary>下载 / 导入</summary>
      <div class="body">
        <form id="export-form" method="POST" action="/export" target="_blank" style="display: inline;">
          <input type="hidden" name="csv_text" id="export_csv_hidden" value="" />
          <input type="hidden" name="include_header" id="export_include_header" value="true" />
          <button type="submit" class="btn" id="export-btn">下载 CSV</button>
        </form>
        <form id="import-form" hx-post="/import" hx-target="#csv-area" hx-swap="outerHTML" hx-encoding="multipart/form-data" style="display: inline; margin-top: 0.5rem;">
          <input type="hidden" name="include_header" id="import_include_header" value="true" />
          <label for="import_file" style="display: inline;">导入 CSV</label>
          <input type="file" id="import_file" name="import_file" accept=".csv" required />
          <button type="submit" id="import-btn">导入</button>
        </form>
      </div>
    </details>
  </div>

  <div style="margin-top: 1rem;">
    <label style="display: inline-flex; align-items: center;">
      <input type="checkbox" id="check_count" name="check_count" checked /> 检测文档数量一致（CSV 与扫描数量需一致）
    </label>
    <form id="save-form" hx-post="/save" hx-target="body" hx-swap="none" style="display: inline;">
      <input type="hidden" name="scan_token" id="scan_token" value="" />
      <input type="hidden" name="csv_text" id="save_csv_hidden" value="" />
      <input type="hidden" name="include_header" id="save_include_header" value="true" />
      <input type="hidden" name="check_count" id="save_check_count" value="true" />
      <button type="submit" id="save-btn" class="btn">保存修改到压缩包</button>
    </form>
    <span class="htmx-indicator">保存中…</span>
  </div>

  <div id="save-log-wrap" style="margin-top: 1rem;">
    <label>保存日志</label>
    <div id="save-log" class="log">{{ save_log }}</div>
  </div>

  <script>
    // 选择子目录后填充「章节压缩包目录」
    document.getElementById('dir_list').addEventListener('change', function() {
      var base = document.getElementById('base_path').value.trim();
      var choice = this.value;
      if (!choice) { document.getElementById('edit_dir').value = ''; return; }
      if (!base) { document.getElementById('edit_dir').value = choice; return; }
      var sep = base.endsWith('/') ? '' : '/';
      document.getElementById('edit_dir').value = base + sep + choice;
    });
    // 导入前同步「包含表头」
    document.getElementById('import-form').addEventListener('submit', function() {
      var cb = document.getElementById('include_header');
      document.getElementById('import_include_header').value = cb && cb.checked ? 'true' : 'false';
    });
    // 导出前把当前 CSV 编辑区内容填入表单，避免下载为空
    document.getElementById('export-form').addEventListener('submit', function() {
      var csvEl = document.getElementById('csv_text');
      document.getElementById('export_csv_hidden').value = csvEl ? csvEl.value : '';
      var cb = document.getElementById('include_header');
      document.getElementById('export_include_header').value = cb && cb.checked ? 'true' : 'false';
    });
    // 保存前先清空保存日志，再把当前 CSV 及选项填入表单
    document.getElementById('save-form').addEventListener('submit', function() {
      var saveLogEl = document.getElementById('save-log');
      if (saveLogEl) saveLogEl.innerHTML = '';
      var csvEl = document.getElementById('csv_text');
      document.getElementById('save_csv_hidden').value = csvEl ? csvEl.value : '';
      var cb = document.getElementById('include_header');
      document.getElementById('save_include_header').value = cb && cb.checked ? 'true' : 'false';
      var checkCb = document.getElementById('check_count');
      document.getElementById('save_check_count').value = checkCb && checkCb.checked ? 'true' : 'false';
    });
  </script>
</body>
</html>
