<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MangaTag - 编辑压缩包内 XML</title>
  <link rel="stylesheet" href="/static/css/style.css" />
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script>htmx.config.allowScriptTags = true;</script>
</head>
<body>
  <div class="main-content">
  <h1>编辑压缩包内 XML</h1>
  <p class="subtitle">扫描目录中的 .cbz/.zip，读取 ComicInfo.xml 后在下方 CSV 中编辑并保存回压缩包。第一列为 FileName（固定），其余列为元数据。</p>

  <section class="section dir-section">
    <h2 class="section-title">目录选择</h2>
    <form id="dir-form" class="dir-form-grid">
      <div class="control-group dir-path-group">
        <label for="base_path">基路径</label>
        <div class="path-with-browse">
          <input type="text" id="base_path" name="base_path" value="{{ default_base_path }}" placeholder="如 /home/user/outputs" />
          <button type="button" id="browse-btn" class="btn" title="浏览文件夹">浏览</button>
        </div>
      </div>
      <div class="control-group dir-select-group">
        <label for="dir_list">漫画文件夹</label>
        <div class="form-row dir-list-row">
          <button type="button" id="refresh-dirs"
            hx-get="/api/dirs"
            hx-include="#base_path"
            hx-target="#dir_list_datalist"
            hx-swap="innerHTML"
            hx-trigger="click">刷新</button>
          <span class="htmx-indicator">加载中…</span>
          <input type="text" id="dir_list" name="dir_list" list="dir_list_datalist"
                 placeholder="输入或选择子目录" class="dir-list-input" />
          <datalist id="dir_list_datalist">
            <option value="">-- 选择 --</option>
          </datalist>
        </div>
      </div>
      <div class="control-group dir-edit-group">
        <label for="edit_dir">章节压缩包目录</label>
        <input type="text" id="edit_dir" name="comic_dir" placeholder="如 /path/to/comic/dir" />
      </div>
    </form>
  </section>

  <section class="section scan-section">
    <h2 class="section-title">扫描选项</h2>
    <div class="form-row scan-options-row">
      <label class="control-group scan-option-item">
        <input type="checkbox" id="include_header" name="include_header" checked /> 包含表头
      </label>
      <div class="control-group scan-option-item">
        <label for="sort_mode">排序</label>
        <select id="sort_mode" name="sort_mode" class="sort-select">
          {% for opt in sort_choices %}
          <option value="{{ opt }}" {% if opt == "按数字大小顺序" %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="button" id="scan-btn" class="btn btn-primary">扫描目录并读取 ComicInfo.xml</button>
      <span class="htmx-indicator">扫描中…</span>
    </div>
  </section>

  <section class="section">
  <div id="csv-area">
    {% include "partials/csv_editor.html" %}
  </div>
  </section>

  <section class="section">
  <details class="accordion">
    <summary>批量编辑</summary>
    <div class="body">
      <p class="batch-hint">基于上方 CSV 区当前内容（扫描后可能已更改）进行编辑。</p>
      <div class="batch-group">
        <div class="batch-group-title">繁简转换</div>
        <div class="form-row">
          <button type="button" id="batch-t2s-all"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
            hx-vals='{"action": "t2s"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">全部列：繁体转简体（除 FileName）</button>
          <button type="button" id="batch-s2t-all"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
            hx-vals='{"action": "s2t"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">全部列：简体转繁体（除 FileName）</button>
        </div>
        <div class="form-row" style="margin-top: 0.5rem;">
          <button type="button" id="batch-t2s-cols"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
            hx-vals='{"action": "t2s"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">所选列：繁体转简体</button>
          <button type="button" id="batch-s2t-cols"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
            hx-vals='{"action": "s2t"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">所选列：简体转繁体</button>
        </div>
      </div>
      <div class="batch-group">
        <div class="batch-group-title">选择批量编辑列</div>
        <div id="batch_columns" class="batch-cols-checkboxes">
          {% for h in csv_headers %}
          {% if h != "FileName" %}
          <label class="batch-cols-option"><input type="checkbox" name="columns" value="{{ h }}" /> {{ h }}</label>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      <div class="batch-group">
        <div class="batch-group-title">批量置为</div>
        <div class="form-row">
          <input type="text" id="batch_set_val" name="batch_set_val" placeholder="值" class="batch-input batch-input-val" />
          <button type="button" id="batch-set-btn"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #batch_set_val"
            hx-vals='{"action": "batch_set"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">执行批量置为</button>
        </div>
      </div>
      <div class="batch-group">
        <div class="batch-group-title">查找替换</div>
        <div class="form-row">
          <input type="text" id="fr_find" name="fr_find" placeholder="查找内容" class="batch-input" />
          <input type="text" id="fr_replace" name="fr_replace" placeholder="替换为" class="batch-input" />
          <button type="button" id="batch-fr-btn"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #fr_find, #fr_replace"
            hx-vals='{"action": "find_replace"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">执行查找替换</button>
        </div>
      </div>
      <div class="batch-group">
        <div class="batch-group-title">前后缀</div>
        <div class="form-row">
          <input type="text" id="prefix_val" name="prefix_val" placeholder="前缀" class="batch-input-small" />
          <button type="button" id="batch-prefix-btn"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #prefix_val"
            hx-vals='{"action": "prefix"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">添加前缀</button>
          <input type="text" id="suffix_val" name="suffix_val" placeholder="后缀" class="batch-input-small" />
          <button type="button" id="batch-suffix-btn"
            hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #suffix_val"
            hx-vals='{"action": "suffix"}' hx-target="body" hx-swap="none" hx-trigger="click"
            hx-on::before-request="window.csvEditor && window.csvEditor.sync()">添加后缀</button>
        </div>
      </div>
    </div>
  </details>
  </section>

  <section class="section">
    <details class="accordion" open>
      <summary>下载 / 导入</summary>
      <div class="body">
        <div class="form-row">
          <form id="export-form" method="POST" action="/export" target="_blank" style="display: inline-flex; align-items: center;">
            <input type="hidden" name="csv_text" id="export_csv_hidden" value="" />
            <input type="hidden" name="include_header" id="export_include_header" value="true" />
            <input type="hidden" name="comic_dir" id="export_comic_dir" value="" />
            <button type="submit" class="btn" id="export-btn">下载 CSV</button>
          </form>
          <form id="import-form" hx-post="/import" hx-target="#csv-area" hx-swap="outerHTML" hx-encoding="multipart/form-data" class="form-row">
            <input type="hidden" name="include_header" id="import_include_header" value="true" />
            <label for="import_file" style="margin: 0;">导入 CSV</label>
            <input type="file" id="import_file" name="import_file" accept=".csv" required />
            <button type="submit" id="import-btn">导入</button>
          </form>
        </div>
      </div>
    </details>
  </section>

  <section class="section save-section">
    <label style="display: inline-flex; align-items: center; margin: 0;">
      <input type="checkbox" id="check_count" name="check_count" checked /> 检测文档数量一致（CSV 与扫描数量需一致）
    </label>
    <form id="save-form" style="display: inline;">
      <input type="hidden" name="scan_token" id="scan_token" value="" />
      <input type="hidden" name="csv_text" id="save_csv_hidden" value="" />
      <input type="hidden" name="include_header" id="save_include_header" value="true" />
      <input type="hidden" name="check_count" id="save_check_count" value="true" />
      <button type="submit" id="save-btn" class="btn btn-primary">保存修改到压缩包</button>
    </form>
    <span id="save-indicator" class="htmx-indicator" style="display: none;">保存中…</span>
  </section>

  <div id="browse-modal" role="dialog" aria-label="浏览文件夹">
    <div class="dialog">
      <h3>选择基路径目录</h3>
      <div id="browse-current" class="current-path">/</div>
      <div id="browse-list" class="folder-list"></div>
      <div class="actions">
        <button type="button" id="browse-cancel" class="btn" style="background: #666;">取消</button>
        <button type="button" id="browse-select" class="btn">选择此目录</button>
      </div>
    </div>
  </div>
  </div>

  <aside class="log-panel" id="log-panel">
    <div class="log-panel-resize-handle" id="log-resize-handle" title="拖动调节宽度"></div>
    <div class="log-panel-header">
      <h2 class="section-title">日志</h2>
      <button type="button" class="log-panel-toggle" id="log-panel-toggle" title="收起/展开">◀</button>
    </div>
    <div class="log-panel-body">
      <div id="unified-log" class="log">{% if scan_log %}{{ scan_log }}{% endif %}{% if save_log %}

--- 保存 ---

{{ save_log }}{% endif %}</div>
    </div>
  </aside>

  <script>
    // 浏览文件夹
    (function() {
      var modal = document.getElementById('browse-modal');
      var currentEl = document.getElementById('browse-current');
      var listEl = document.getElementById('browse-list');
      var browseBtn = document.getElementById('browse-btn');
      var cancelBtn = document.getElementById('browse-cancel');
      var selectBtn = document.getElementById('browse-select');
      var basePathInput = document.getElementById('base_path');
      var currentPath = '';

      function loadBrowse(path) {
        var url = '/api/browse' + (path ? '?path=' + encodeURIComponent(path) : '');
        fetch(url).then(function(r) {
          if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || '加载失败'); });
          return r.json();
        }).then(function(data) {
          currentPath = data.current;
          currentEl.textContent = data.current || '/';
          listEl.innerHTML = '';
          if (data.parent) {
            var parentBtn = document.createElement('button');
            parentBtn.type = 'button';
            parentBtn.className = 'folder-item parent';
            parentBtn.textContent = '上一级';
            parentBtn.dataset.path = data.parent;
            parentBtn.addEventListener('click', function() { loadBrowse(data.parent); });
            listEl.appendChild(parentBtn);
          }
          data.entries.forEach(function(e) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'folder-item';
            btn.textContent = e.name;
            btn.dataset.path = e.path;
            btn.addEventListener('click', function() { loadBrowse(e.path); });
            listEl.appendChild(btn);
          });
        }).catch(function(err) {
          currentEl.textContent = '错误: ' + err.message;
          listEl.innerHTML = '';
        });
      }

      browseBtn.addEventListener('click', function() {
        var start = basePathInput.value.trim();
        modal.classList.add('open');
        loadBrowse(start || undefined);
      });
      cancelBtn.addEventListener('click', function() { modal.classList.remove('open'); });
      selectBtn.addEventListener('click', function() {
        if (currentPath) basePathInput.value = currentPath;
        modal.classList.remove('open');
      });
      modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.classList.remove('open');
      });
    })();

    // 导入/扫描/批量编辑后，若 #csv-area 被替换，需手动渲染表格（allowScriptTags 可能仍不执行，此作为后备）
    function maybeRenderCsvTable() {
      var dataEl = document.getElementById('csv-initial-data');
      var wrap = document.getElementById('csv-table-wrap');
      if (!dataEl || !wrap) return;
      var csv = '';
      if (dataEl.textContent && dataEl.textContent.trim()) {
        try {
          csv = JSON.parse(dataEl.textContent);
        } catch (e) {
          csv = '';
        }
      }
      var ta = document.getElementById('csv_text');
      if (ta) ta.value = csv;
      if (window.csvEditor && window.csvEditor.render) window.csvEditor.render('csv-table-wrap', csv);
    }
    document.body.addEventListener('htmx:afterSwap', function(ev) {
      if (ev.detail && ev.detail.target && (ev.detail.target.id === 'csv-area' || (ev.detail.target.querySelector && ev.detail.target.querySelector('#csv-initial-data')))) maybeRenderCsvTable();
    });
    document.body.addEventListener('htmx:afterSettle', function() {
      if (document.getElementById('csv-initial-data') && !document.getElementById('csv-data-table')) {
        setTimeout(maybeRenderCsvTable, 0);
      }
    });

    // 批量编辑前：HTMX 在 beforeRequest 之前就收集了表单值，需在 configRequest 中同步表格到 csv_text
    document.body.addEventListener('htmx:configRequest', function(ev) {
      var el = ev.detail && ev.detail.elt;
      if (!el || (el.getAttribute('hx-post') || '').indexOf('batch-edit') < 0) return;
      if (window.csvEditor && window.csvEditor.sync) window.csvEditor.sync();
      var ta = document.getElementById('csv_text');
      if (ta && ev.detail.parameters) ev.detail.parameters['csv_text'] = ta.value;
    });

    // 漫画文件夹输入：简繁体不敏感搜索，动态更新 datalist
    (function() {
      var input = document.getElementById('dir_list');
      var baseInput = document.getElementById('base_path');
      var datalist = document.getElementById('dir_list_datalist');
      if (!input || !baseInput || !datalist) return;

      var lastController = null;

      function escapeHtml(str) {
        return (str || '').replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/"/g, '&quot;');
      }

      function updateDatalist(entries) {
        var html = '<option value=\"\">-- 选择 --</option>';
        if (Array.isArray(entries)) {
          entries.forEach(function(item) {
            var rel, search;
            if (typeof item === 'string') {
              rel = item;
              search = item;
            } else {
              rel = item && item.rel || '';
              search = item && item.search || rel;
            }
            if (!rel) return;
            var escRel = escapeHtml(rel);
            var escSearch = escapeHtml(search);
            // value 用于浏览器匹配（含多种繁简形式），data-rel 保留真实相对路径
            html += '<option value=\"' + escSearch + '\" data-rel=\"' + escRel + '\" label=\"' + escRel + '\"></option>';
          });
        }
        datalist.innerHTML = html;
      }

      function fetchDirs(q) {
        var base = baseInput.value.trim();
        var params = new URLSearchParams();
        if (base) params.append('base_path', base);
        if (q) params.append('q', q);
        if (lastController) {
          lastController.abort();
        }
        lastController = ('AbortController' in window) ? new AbortController() : null;
        var opts = {};
        if (lastController) {
          opts.signal = lastController.signal;
        }
        fetch('/api/dirs-search?' + params.toString(), opts)
          .then(function(res) { return res.ok ? res.json() : { entries: [] }; })
          .then(function(data) {
            updateDatalist((data && data.entries) || []);
          })
          .catch(function(err) {
            if (err && err.name === 'AbortError') return;
            // 出错时保持现有列表
          });
      }

      input.addEventListener('input', function() {
        fetchDirs(this.value.trim());
      });

      input.addEventListener('focus', function() {
        fetchDirs(this.value.trim());
      });
    })();

    // 扫描：流式请求 /scan-stream，逐条追加到扫描日志；
    // 同时通过 /scan-json 拉取 CSV 文本并直接刷新表格与 scan_token。
    (function() {
      var scanBtn = document.getElementById('scan-btn');
      if (!scanBtn) return;
      scanBtn.addEventListener('click', function() {
        var unifiedLogEl = document.getElementById('unified-log');
        if (unifiedLogEl) unifiedLogEl.textContent = '扫描中…';

        var comicDir = (document.getElementById('edit_dir') || {}).value || '';
        var includeHeaderCb = document.getElementById('include_header');
        var sortModeEl = document.getElementById('sort_mode');
        var includeHeaderVal = includeHeaderCb && includeHeaderCb.checked ? 'true' : 'false';
        var sortModeVal = sortModeEl ? sortModeEl.value : '按数字大小顺序';

        var formData1 = new FormData();
        formData1.append('comic_dir', comicDir);
        formData1.append('include_header', includeHeaderVal);
        formData1.append('sort_mode', sortModeVal);

        // 1）流式日志
        fetch('/scan-stream', { method: 'POST', body: formData1 })
          .then(function(res) {
            if (!res.body) return;
            var reader = res.body.getReader();
            var decoder = new TextDecoder();
            function read() {
              return reader.read().then(function(opt) {
                if (opt.done) return;
                var text = decoder.decode(opt.value, { stream: true });
                if (unifiedLogEl) {
                  // 若是第一次块并且仍然是「扫描中…」，先清空
                  if (unifiedLogEl.textContent === '扫描中…') {
                    unifiedLogEl.textContent = '';
                  }
                  unifiedLogEl.textContent += text;
                }
                return read();
              });
            }
            return read();
          })
          .catch(function(err) {
            if (unifiedLogEl) {
              unifiedLogEl.textContent = (unifiedLogEl.textContent || '') + '\n请求失败: ' + err.message;
            }
          });

        // 2）JSON 结果：直接刷新 CSV 表格与 scan_token
        var formData2 = new FormData();
        formData2.append('comic_dir', comicDir);
        formData2.append('include_header', includeHeaderVal);
        formData2.append('sort_mode', sortModeVal);
        fetch('/scan-json', { method: 'POST', body: formData2 })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (!data || !data.ok) {
              if (unifiedLogEl && data && data.error) {
                unifiedLogEl.textContent = data.error;
              }
              return;
            }
            var csv = data.csv_text || '';
            var ta = document.getElementById('csv_text');
            if (ta) ta.value = csv;
            var tokenInput = document.getElementById('scan_token');
            if (tokenInput && data.scan_token) {
              tokenInput.value = data.scan_token;
            }
            if (window.csvEditor && window.csvEditor.render) {
              window.csvEditor.render('csv-table-wrap', csv);
            }
          })
          .catch(function(err) {
            if (unifiedLogEl) {
              unifiedLogEl.textContent = (unifiedLogEl.textContent || '') + '\n获取 CSV 结果失败: ' + err.message;
            }
          });
      });
    })();

    // 选择子目录后填充「章节压缩包目录」
    document.getElementById('dir_list').addEventListener('change', function() {
      var base = document.getElementById('base_path').value.trim();
      var choiceVal = this.value;
      var rel = choiceVal;
      var dl = document.getElementById('dir_list_datalist');
      if (dl && choiceVal) {
        var opts = dl.options || [];
        for (var i = 0; i < opts.length; i++) {
          if (opts[i].value === choiceVal && opts[i].dataset && opts[i].dataset.rel) {
            rel = opts[i].dataset.rel;
            break;
          }
        }
      }
      // 将输入框中的值也同步成真实相对路径，避免后续困惑
      this.value = rel;

      if (!rel) { document.getElementById('edit_dir').value = ''; return; }
      if (!base) { document.getElementById('edit_dir').value = rel; return; }
      var sep = base.endsWith('/') ? '' : '/';
      document.getElementById('edit_dir').value = base + sep + rel;
    });
    // 导入前同步「包含表头」
    document.getElementById('import-form').addEventListener('submit', function() {
      var cb = document.getElementById('include_header');
      document.getElementById('import_include_header').value = cb && cb.checked ? 'true' : 'false';
    });
    // 导出前把当前 CSV 编辑区内容和章节目录填入表单，避免下载为空，并用于生成文件名
    document.getElementById('export-form').addEventListener('submit', function() {
      if (window.csvEditor && window.csvEditor.sync) window.csvEditor.sync();
      var csvEl = document.getElementById('csv_text');
      document.getElementById('export_csv_hidden').value = csvEl ? csvEl.value : '';
      var cb = document.getElementById('include_header');
      document.getElementById('export_include_header').value = cb && cb.checked ? 'true' : 'false';
      var editDirEl = document.getElementById('edit_dir');
      document.getElementById('export_comic_dir').value = editDirEl ? (editDirEl.value || '') : '';
    });
    // 保存：流式请求 /save-stream，逐条追加到保存日志
    document.getElementById('save-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var form = this;
      var unifiedLogEl = document.getElementById('unified-log');
      var saveBtn = document.getElementById('save-btn');
      var saveIndicator = document.getElementById('save-indicator');
      if (!unifiedLogEl || !saveBtn) return;

      // 同步表单隐藏域（表格 -> csv_text -> 隐藏域）
      if (window.csvEditor && window.csvEditor.sync) window.csvEditor.sync();
      var csvEl = document.getElementById('csv_text');
      document.getElementById('save_csv_hidden').value = csvEl ? csvEl.value : '';
      var cb = document.getElementById('include_header');
      document.getElementById('save_include_header').value = cb && cb.checked ? 'true' : 'false';
      var checkCb = document.getElementById('check_count');
      document.getElementById('save_check_count').value = checkCb && checkCb.checked ? 'true' : 'false';

      if (unifiedLogEl.textContent) unifiedLogEl.textContent += '\n\n--- 保存 ---\n';
      form.classList.add('saving');
      if (saveIndicator) saveIndicator.style.display = 'inline';

      // 为避免 multipart 单字段 1MB 限制，这里以 JSON 形式提交到 /save-stream
      var payload = {
        csv_text: document.getElementById('save_csv_hidden').value || '',
        include_header: document.getElementById('save_include_header').value || 'true',
        check_count: document.getElementById('save_check_count').value || 'true',
        scan_token: document.getElementById('scan_token').value || ''
      };

      fetch('/save-stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(function(res) {
          if (!res.body) return;
          var reader = res.body.getReader();
          var decoder = new TextDecoder();

          function read() {
            return reader.read().then(function(opt) {
              if (opt.done) return;
              var text = decoder.decode(opt.value, { stream: true });
              unifiedLogEl.textContent += text;
              return read();
            });
          }

          return read();
        })
        .catch(function(err) {
          unifiedLogEl.textContent = (unifiedLogEl.textContent || '') + '\n请求失败: ' + err.message;
        })
        .finally(function() {
          form.classList.remove('saving');
          if (saveIndicator) saveIndicator.style.display = 'none';
        });
    });

    // 日志栏：收起/展开、调节宽度
    (function() {
      var panel = document.getElementById('log-panel');
      var toggleBtn = document.getElementById('log-panel-toggle');
      var resizeHandle = document.getElementById('log-resize-handle');
      if (!panel || !toggleBtn || !resizeHandle) return;

      var STORAGE_KEY = 'mangatag_log_panel';
      var DEFAULT_WIDTH = 320;
      var MIN_WIDTH = 200;
      var MAX_WIDTH_PX = Math.min(800, window.innerWidth * 0.8);

      function loadState() {
        try {
          var s = localStorage.getItem(STORAGE_KEY);
          if (s) {
            var d = JSON.parse(s);
            if (d.collapsed) panel.classList.add('collapsed');
            if (typeof d.width === 'number' && d.width >= MIN_WIDTH) {
              panel.style.setProperty('--log-panel-width', d.width + 'px');
            }
          }
        } catch (e) {}
      }
      function saveState() {
        try {
          var collapsed = panel.classList.contains('collapsed');
          var w = parseInt(getComputedStyle(panel).width, 10) || DEFAULT_WIDTH;
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ collapsed: collapsed, width: w }));
        } catch (e) {}
      }

      toggleBtn.addEventListener('click', function() {
        panel.classList.toggle('collapsed');
        saveState();
      });

      var startX, startW;
      resizeHandle.addEventListener('mousedown', function(e) {
        if (panel.classList.contains('collapsed')) return;
        e.preventDefault();
        startX = e.clientX;
        startW = panel.offsetWidth;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        function onMove(e) {
          var dx = e.clientX - startX;
          var newW = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH_PX, startW - dx));
          panel.style.setProperty('--log-panel-width', newW + 'px');
        }
        function onUp() {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
          saveState();
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });

      loadState();
    })();
  </script>
</body>
</html>
