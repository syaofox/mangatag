<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MangaTag - ç¼–è¾‘å‹ç¼©åŒ…å†… XML</title>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: #fff; color: #333; margin: 0; padding: 1rem 2rem; line-height: 1.5; }
    h1 { font-size: 1.25rem; margin-bottom: 0.5rem; }
    .subtitle { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
    label { display: block; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #555; }
    input[type="text"], select, textarea { width: 100%; max-width: 640px; padding: 0.5rem; background: #fff; border: 1px solid #ccc; border-radius: 4px; color: #333; }
    textarea { min-height: 120px; font-family: ui-monospace, monospace; font-size: 0.875rem; }
    #csv-area textarea { min-height: 280px; max-width: none; width: 100%; }
    button, .btn { display: inline-block; padding: 0.5rem 1rem; background: #0066cc; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-right: 0.5rem; margin-top: 0.5rem; }
    button:hover, .btn:hover { background: #0052a3; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
    .col { flex: 1; min-width: 200px; }
    .log { white-space: pre-wrap; font-family: ui-monospace, monospace; font-size: 0.8rem; background: #f5f5f5; padding: 0.75rem; border-radius: 4px; min-height: 80px; border: 1px solid #ddd; }
    .accordion { border: 1px solid #ccc; border-radius: 4px; margin-top: 1rem; background: #fafafa; }
    .accordion summary { padding: 0.5rem 1rem; cursor: pointer; }
    .accordion .body { padding: 1rem; border-top: 1px solid #ccc; }
    .batch-cols-label { display: inline-block; margin-right: 0.5rem; vertical-align: top; color: #555; }
    .batch-cols-checkboxes { display: flex; flex-wrap: wrap; gap: 0.5rem 1.5rem; align-items: center; }
    .batch-cols-option { display: inline-flex; align-items: center; gap: 0.25rem; cursor: pointer; white-space: nowrap; }
    a.btn, a#export-btn { color: #fff; text-decoration: none; }
    .htmx-request .htmx-indicator { display: inline; }
    .htmx-indicator { display: none; }
    /* è¯·æ±‚è¿›è¡Œä¸­ç¦ç”¨æŒ‰é’®ï¼Œé¿å…é‡å¤æäº¤å¯¼è‡´æ—¥å¿—ä¸æ“ä½œé”™ä½ */
    #scan-btn.htmx-request { pointer-events: none; opacity: 0.7; }
    #save-form.saving #save-btn { pointer-events: none; opacity: 0.7; }
    .path-with-browse { display: flex; gap: 0.5rem; align-items: center; max-width: 640px; }
    .path-with-browse input { flex: 1; min-width: 0; }
    .path-with-browse .btn { flex-shrink: 0; margin-top: 0; }
    #browse-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; }
    #browse-modal.open { display: flex; }
    #browse-modal .dialog { background: #fff; border-radius: 8px; padding: 1.25rem; min-width: 360px; max-width: 90vw; max-height: 70vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    #browse-modal .dialog h3 { margin: 0 0 0.75rem; font-size: 1rem; }
    #browse-modal .current-path { font-size: 0.85rem; color: #555; word-break: break-all; margin-bottom: 0.75rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px; }
    #browse-modal .folder-list { overflow-y: auto; max-height: 280px; border: 1px solid #ddd; border-radius: 4px; padding: 0.25rem; }
    #browse-modal .folder-item { display: block; width: 100%; padding: 0.5rem 0.75rem; text-align: left; border: none; background: none; cursor: pointer; border-radius: 4px; font-size: 0.95rem; color: #333; }
    #browse-modal .folder-item:hover { background: #e8f0fe; }
    #browse-modal .folder-item::before { content: "ğŸ“ "; }
    #browse-modal .folder-item.parent::before { content: "â¬† "; }
    #browse-modal .actions { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
  </style>
</head>
<body>
  <h1>ç¼–è¾‘å‹ç¼©åŒ…å†… XML</h1>
  <p class="subtitle">æ‰«æç›®å½•ä¸­çš„ .cbz/.zipï¼Œè¯»å– ComicInfo.xml ååœ¨ä¸‹æ–¹ CSV ä¸­ç¼–è¾‘å¹¶ä¿å­˜å›å‹ç¼©åŒ…ã€‚ç¬¬ä¸€åˆ—ä¸º FileNameï¼ˆå›ºå®šï¼‰ï¼Œå…¶ä½™åˆ—ä¸ºå…ƒæ•°æ®ã€‚</p>

  <form id="dir-form" class="row">
    <div class="col">
      <label for="base_path">åŸºè·¯å¾„</label>
      <div class="path-with-browse">
        <input type="text" id="base_path" name="base_path" value="{{ default_base_path }}" placeholder="å¦‚ /home/user/outputs" />
        <button type="button" id="browse-btn" class="btn" title="æµè§ˆæ–‡ä»¶å¤¹">æµè§ˆ</button>
      </div>
    </div>
    <div class="col">
      <button type="button" id="refresh-dirs"
        hx-get="/api/dirs"
        hx-include="#base_path"
        hx-target="#dir_list"
        hx-swap="innerHTML"
        hx-trigger="click">åˆ·æ–°</button>
      <span class="htmx-indicator">åŠ è½½ä¸­â€¦</span>
    </div>
    <div class="col">
      <label for="dir_list">æ¼«ç”»æ–‡ä»¶å¤¹åˆ—è¡¨</label>
      <select id="dir_list" name="dir_list">
        <option value="">-- é€‰æ‹© --</option>
      </select>
    </div>
    <div class="col" style="flex: 2;">
      <label for="edit_dir">ç« èŠ‚å‹ç¼©åŒ…ç›®å½•</label>
      <input type="text" id="edit_dir" name="comic_dir" placeholder="å¦‚ /path/to/comic/dir" />
    </div>
  </form>

  <div class="row" style="margin-top: 0.5rem;">
    <label style="display: inline-flex; align-items: center; margin-right: 1rem;">
      <input type="checkbox" id="include_header" name="include_header" checked /> åŒ…å«è¡¨å¤´
    </label>
    <div style="display: inline-block;">
      <label for="sort_mode" style="display: inline; margin-right: 0.5rem;">æ’åº</label>
      <select id="sort_mode" name="sort_mode">
        {% for opt in sort_choices %}
        <option value="{{ opt }}" {% if opt == "æŒ‰æ•°å­—å¤§å°é¡ºåº" %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </div>
    <span>
      <button type="button" id="scan-btn"
        hx-post="/scan"
        hx-include="#edit_dir, #include_header, #sort_mode"
        hx-target="body"
        hx-swap="none"
        hx-trigger="click"
        hx-on::click="var sl=document.getElementById('scan-log'); var sv=document.getElementById('save-log'); if(sl){sl.innerHTML='';} if(sv){sv.innerHTML='';} if(sl){sl.innerHTML='æ‰«æä¸­â€¦';}"
        >æ‰«æç›®å½•å¹¶è¯»å– ComicInfo.xml</button>
      <span class="htmx-indicator">æ‰«æä¸­â€¦</span>
    </span>
  </div>

  <div id="scan-log-wrap" style="margin-top: 1rem;">
    <label>æ‰«ææ—¥å¿—</label>
    <div id="scan-log" class="log">{{ scan_log }}</div>
  </div>

  <div id="csv-area" style="margin-top: 1rem;">
    <label>CSV ç¼–è¾‘åŒº</label>
    <textarea id="csv_text" name="csv_text" rows="18">{{ csv_text }}</textarea>
  </div>

  <details class="accordion">
    <summary>æ‰¹é‡ç¼–è¾‘</summary>
    <div class="body">
      <div class="row">
        <button type="button" id="batch-t2s-all"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
          hx-vals='{"action": "t2s"}' hx-target="body" hx-swap="none" hx-trigger="click">å…¨éƒ¨åˆ—ï¼šç¹ä½“è½¬ç®€ä½“ï¼ˆé™¤ FileNameï¼‰</button>
        <button type="button" id="batch-s2t-all"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
          hx-vals='{"action": "s2t"}' hx-target="body" hx-swap="none" hx-trigger="click">å…¨éƒ¨åˆ—ï¼šç®€ä½“è½¬ç¹ä½“ï¼ˆé™¤ FileNameï¼‰</button>
      </div>
      <div class="row">
        <span class="batch-cols-label">é€‰æ‹©æ‰¹é‡ç¼–è¾‘åˆ—</span>
        <div id="batch_columns" class="batch-cols-checkboxes">
          {% for h in csv_headers %}
          {% if h != "FileName" %}
          <label class="batch-cols-option"><input type="checkbox" name="columns" value="{{ h }}" /> {{ h }}</label>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      <div class="row">
        <button type="button" id="batch-t2s-cols"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
          hx-vals='{"action": "t2s"}' hx-target="body" hx-swap="none" hx-trigger="click">æ‰€é€‰åˆ—ï¼šç¹ä½“è½¬ç®€ä½“</button>
        <button type="button" id="batch-s2t-cols"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns input[name=columns]:checked"
          hx-vals='{"action": "s2t"}' hx-target="body" hx-swap="none" hx-trigger="click">æ‰€é€‰åˆ—ï¼šç®€ä½“è½¬ç¹ä½“</button>
      </div>
      <div class="row">
        <input type="text" id="batch_set_val" name="batch_set_val" placeholder="æ‰¹é‡ç½®ä¸ºï¼šå€¼" style="max-width: 240px;" />
        <button type="button" id="batch-set-btn"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #batch_set_val"
          hx-vals='{"action": "batch_set"}' hx-target="body" hx-swap="none" hx-trigger="click">æ‰§è¡Œæ‰¹é‡ç½®ä¸º</button>
      </div>
      <div class="row">
        <input type="text" id="fr_find" name="fr_find" placeholder="æŸ¥æ‰¾å†…å®¹" style="max-width: 200px;" />
        <input type="text" id="fr_replace" name="fr_replace" placeholder="æ›¿æ¢ä¸º" style="max-width: 200px;" />
        <button type="button" id="batch-fr-btn"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #fr_find, #fr_replace"
          hx-vals='{"action": "find_replace"}' hx-target="body" hx-swap="none" hx-trigger="click">æ‰§è¡ŒæŸ¥æ‰¾æ›¿æ¢</button>
      </div>
      <div class="row">
        <input type="text" id="prefix_val" name="prefix_val" placeholder="å‰ç¼€" style="max-width: 120px;" />
        <button type="button" id="batch-prefix-btn"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #prefix_val"
          hx-vals='{"action": "prefix"}' hx-target="body" hx-swap="none" hx-trigger="click">æ·»åŠ å‰ç¼€</button>
        <input type="text" id="suffix_val" name="suffix_val" placeholder="åç¼€" style="max-width: 120px;" />
        <button type="button" id="batch-suffix-btn"
          hx-post="/batch-edit" hx-include="#csv_text, #include_header, #batch_columns, #suffix_val"
          hx-vals='{"action": "suffix"}' hx-target="body" hx-swap="none" hx-trigger="click">æ·»åŠ åç¼€</button>
      </div>
    </div>
  </details>

  <div class="row" style="margin-top: 1rem;">
    <details class="accordion" open>
      <summary>ä¸‹è½½ / å¯¼å…¥</summary>
      <div class="body">
        <form id="export-form" method="POST" action="/export" target="_blank" style="display: inline;">
          <input type="hidden" name="csv_text" id="export_csv_hidden" value="" />
          <input type="hidden" name="include_header" id="export_include_header" value="true" />
          <button type="submit" class="btn" id="export-btn">ä¸‹è½½ CSV</button>
        </form>
        <form id="import-form" hx-post="/import" hx-target="#csv-area" hx-swap="outerHTML" hx-encoding="multipart/form-data" style="display: inline; margin-top: 0.5rem;">
          <input type="hidden" name="include_header" id="import_include_header" value="true" />
          <label for="import_file" style="display: inline;">å¯¼å…¥ CSV</label>
          <input type="file" id="import_file" name="import_file" accept=".csv" required />
          <button type="submit" id="import-btn">å¯¼å…¥</button>
        </form>
      </div>
    </details>
  </div>

  <div style="margin-top: 1rem;">
    <label style="display: inline-flex; align-items: center;">
      <input type="checkbox" id="check_count" name="check_count" checked /> æ£€æµ‹æ–‡æ¡£æ•°é‡ä¸€è‡´ï¼ˆCSV ä¸æ‰«ææ•°é‡éœ€ä¸€è‡´ï¼‰
    </label>
    <form id="save-form" style="display: inline;">
      <input type="hidden" name="scan_token" id="scan_token" value="" />
      <input type="hidden" name="csv_text" id="save_csv_hidden" value="" />
      <input type="hidden" name="include_header" id="save_include_header" value="true" />
      <input type="hidden" name="check_count" id="save_check_count" value="true" />
      <button type="submit" id="save-btn" class="btn">ä¿å­˜ä¿®æ”¹åˆ°å‹ç¼©åŒ…</button>
    </form>
    <span id="save-indicator" class="htmx-indicator" style="display: none;">ä¿å­˜ä¸­â€¦</span>
  </div>

  <div id="save-log-wrap" style="margin-top: 1rem;">
    <label>ä¿å­˜æ—¥å¿—</label>
    <div id="save-log" class="log">{{ save_log }}</div>
  </div>

  <div id="browse-modal" role="dialog" aria-label="æµè§ˆæ–‡ä»¶å¤¹">
    <div class="dialog">
      <h3>é€‰æ‹©åŸºè·¯å¾„ç›®å½•</h3>
      <div id="browse-current" class="current-path">/</div>
      <div id="browse-list" class="folder-list"></div>
      <div class="actions">
        <button type="button" id="browse-cancel" class="btn" style="background: #666;">å–æ¶ˆ</button>
        <button type="button" id="browse-select" class="btn">é€‰æ‹©æ­¤ç›®å½•</button>
      </div>
    </div>
  </div>

  <script>
    // æµè§ˆæ–‡ä»¶å¤¹
    (function() {
      var modal = document.getElementById('browse-modal');
      var currentEl = document.getElementById('browse-current');
      var listEl = document.getElementById('browse-list');
      var browseBtn = document.getElementById('browse-btn');
      var cancelBtn = document.getElementById('browse-cancel');
      var selectBtn = document.getElementById('browse-select');
      var basePathInput = document.getElementById('base_path');
      var currentPath = '';

      function loadBrowse(path) {
        var url = '/api/browse' + (path ? '?path=' + encodeURIComponent(path) : '');
        fetch(url).then(function(r) {
          if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || 'åŠ è½½å¤±è´¥'); });
          return r.json();
        }).then(function(data) {
          currentPath = data.current;
          currentEl.textContent = data.current || '/';
          listEl.innerHTML = '';
          if (data.parent) {
            var parentBtn = document.createElement('button');
            parentBtn.type = 'button';
            parentBtn.className = 'folder-item parent';
            parentBtn.textContent = 'ä¸Šä¸€çº§';
            parentBtn.dataset.path = data.parent;
            parentBtn.addEventListener('click', function() { loadBrowse(data.parent); });
            listEl.appendChild(parentBtn);
          }
          data.entries.forEach(function(e) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'folder-item';
            btn.textContent = e.name;
            btn.dataset.path = e.path;
            btn.addEventListener('click', function() { loadBrowse(e.path); });
            listEl.appendChild(btn);
          });
        }).catch(function(err) {
          currentEl.textContent = 'é”™è¯¯: ' + err.message;
          listEl.innerHTML = '';
        });
      }

      browseBtn.addEventListener('click', function() {
        var start = basePathInput.value.trim();
        modal.classList.add('open');
        loadBrowse(start || undefined);
      });
      cancelBtn.addEventListener('click', function() { modal.classList.remove('open'); });
      selectBtn.addEventListener('click', function() {
        if (currentPath) basePathInput.value = currentPath;
        modal.classList.remove('open');
      });
      modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.classList.remove('open');
      });
    })();

    // é€‰æ‹©å­ç›®å½•åå¡«å……ã€Œç« èŠ‚å‹ç¼©åŒ…ç›®å½•ã€
    document.getElementById('dir_list').addEventListener('change', function() {
      var base = document.getElementById('base_path').value.trim();
      var choice = this.value;
      if (!choice) { document.getElementById('edit_dir').value = ''; return; }
      if (!base) { document.getElementById('edit_dir').value = choice; return; }
      var sep = base.endsWith('/') ? '' : '/';
      document.getElementById('edit_dir').value = base + sep + choice;
    });
    // å¯¼å…¥å‰åŒæ­¥ã€ŒåŒ…å«è¡¨å¤´ã€
    document.getElementById('import-form').addEventListener('submit', function() {
      var cb = document.getElementById('include_header');
      document.getElementById('import_include_header').value = cb && cb.checked ? 'true' : 'false';
    });
    // å¯¼å‡ºå‰æŠŠå½“å‰ CSV ç¼–è¾‘åŒºå†…å®¹å¡«å…¥è¡¨å•ï¼Œé¿å…ä¸‹è½½ä¸ºç©º
    document.getElementById('export-form').addEventListener('submit', function() {
      var csvEl = document.getElementById('csv_text');
      document.getElementById('export_csv_hidden').value = csvEl ? csvEl.value : '';
      var cb = document.getElementById('include_header');
      document.getElementById('export_include_header').value = cb && cb.checked ? 'true' : 'false';
    });
    // ä¿å­˜ï¼šæµå¼è¯·æ±‚ /save-streamï¼Œé€æ¡è¿½åŠ åˆ°ä¿å­˜æ—¥å¿—
    document.getElementById('save-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var form = this;
      var saveLogEl = document.getElementById('save-log');
      var saveBtn = document.getElementById('save-btn');
      var saveIndicator = document.getElementById('save-indicator');
      if (!saveLogEl || !saveBtn) return;

      // åŒæ­¥è¡¨å•éšè—åŸŸ
      var csvEl = document.getElementById('csv_text');
      document.getElementById('save_csv_hidden').value = csvEl ? csvEl.value : '';
      var cb = document.getElementById('include_header');
      document.getElementById('save_include_header').value = cb && cb.checked ? 'true' : 'false';
      var checkCb = document.getElementById('check_count');
      document.getElementById('save_check_count').value = checkCb && checkCb.checked ? 'true' : 'false';

      saveLogEl.textContent = '';
      form.classList.add('saving');
      if (saveIndicator) saveIndicator.style.display = 'inline';

      var formData = new FormData(form);
      fetch('/save-stream', { method: 'POST', body: formData })
        .then(function(res) {
          if (!res.body) return;
          var reader = res.body.getReader();
          var decoder = new TextDecoder();
          function read() {
            return reader.read().then(function(opt) {
              if (opt.done) return;
              var text = decoder.decode(opt.value, { stream: true });
              saveLogEl.textContent += text;
              return read();
            });
          }
          return read();
        })
        .catch(function(err) {
          saveLogEl.textContent = (saveLogEl.textContent || '') + '\nè¯·æ±‚å¤±è´¥: ' + err.message;
        })
        .finally(function() {
          form.classList.remove('saving');
          if (saveIndicator) saveIndicator.style.display = 'none';
        });
    });
  </script>
</body>
</html>
