{# CSV 轻量表格编辑器：隐藏 textarea 存原始 CSV，可见表格供编辑 #}
<label>CSV 编辑区</label>
<textarea id="csv_text" name="csv_text" style="display:none"></textarea>
{# 注意：为避免 CSV 内容中的 "</script" 终止脚本，这里将 JSON 中的 "</" 转义为 "<\/" #}
<script type="application/json" id="csv-initial-data">{{ csv_text | tojson | replace('</', '<\\/') }}</script>
<div id="csv-table-wrap" class="csv-table-container"></div>
<script>
(function() {
  var CSV_HEADERS = {{ csv_headers | tojson }};
  var initialDataEl = document.getElementById('csv-initial-data');
  var initialCsv = '';
  if (initialDataEl && initialDataEl.textContent) {
    try {
      initialCsv = JSON.parse(initialDataEl.textContent);
    } catch (e) {
      initialCsv = '';
    }
  }
  document.getElementById('csv_text').value = initialCsv;
  function parseCSV(text) {
    if (!text || !text.trim()) return { headers: CSV_HEADERS.slice(), rows: [] };
    var rows = [];
    var i = 0, len = text.length;
    function skipWs() { while (i < len && (text[i] === ' ' || text[i] === '\t')) i++; }
    function readField() {
      skipWs();
      if (i >= len) return '';
      if (text[i] === '"') {
        i++;
        var s = '';
        while (i < len) {
          if (text[i] === '"') {
            i++;
            if (i < len && text[i] === '"') { s += '"'; i++; }
            else break;
          } else { s += text[i]; i++; }
        }
        skipWs();
        if (i < len && text[i] === ',') i++;
        return s;
      }
      var start = i;
      while (i < len && text[i] !== ',' && text[i] !== '\r' && text[i] !== '\n') i++;
      var s = text.slice(start, i).trim();
      if (i < len && text[i] === ',') i++;
      return s;
    }
    while (i < len) {
      var row = [];
      while (i < len && text[i] !== '\r' && text[i] !== '\n') row.push(readField());
      if (row.length) rows.push(row);
      while (i < len && (text[i] === '\r' || text[i] === '\n')) i++;
    }
    return rows;
  }
  function serializeCSV(rows) {
    function escape(f) {
      var s = String(f == null ? '' : f);
      if (/[",\r\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }
    return rows.map(function(r) { return r.map(escape).join(','); }).join('\n');
  }
  function moveRow(table, fromIdx, toIdx) {
    if (fromIdx === toIdx) return;
    var tbody = table.querySelector('tbody');
    var trs = tbody.querySelectorAll('tr');
    var tr = trs[fromIdx];
    var ref = toIdx < fromIdx ? trs[toIdx] : (trs[toIdx].nextSibling || null);
    tbody.insertBefore(tr, ref);
    sync();
  }
  function swapColumns(table, fromIdx, toIdx) {
    if (fromIdx === toIdx) return;
    var thr = table.querySelector('thead tr');
    var ths = thr.querySelectorAll('th');
    var hText = ths[fromIdx].textContent;
    ths[fromIdx].textContent = ths[toIdx].textContent;
    ths[toIdx].textContent = hText;
    var trs = table.querySelectorAll('tbody tr');
    for (var r = 0; r < trs.length; r++) {
      var tds = trs[r].querySelectorAll('td');
      var inpFrom = tds[fromIdx].querySelector('input');
      var inpTo = tds[toIdx].querySelector('input');
      var v = inpFrom.value;
      inpFrom.value = inpTo.value;
      inpTo.value = v;
    }
    sync();
  }
  function sortColumn(table, colIdx, ascending) {
    var trs = Array.prototype.slice.call(table.querySelectorAll('tbody tr'));
    var getVal = function(tr) {
      var inp = tr.querySelectorAll('td input')[colIdx];
      return inp ? String(inp.value || '').trim() : '';
    };
    trs.sort(function(a, b) {
      var va = getVal(a), vb = getVal(b);
      if (va === '' && vb === '') return 0;
      if (va === '') return 1;
      if (vb === '') return -1;
      var cmp = va.localeCompare(vb, undefined, { numeric: true });
      return ascending ? cmp : -cmp;
    });
    var tbody = table.querySelector('tbody');
    trs.forEach(function(tr) { tbody.appendChild(tr); });
    sync();
  }
  function convertColumn(table, colIdx, action) {
    var ths = table.querySelectorAll('thead th');
    var th = ths[colIdx];
    if (!th) return;
    var headerName = (th.textContent || '').trim();
    if (!headerName || headerName === 'FileName') return;
    sync();
    var csvEl = document.getElementById('csv_text');
    var includeCb = document.getElementById('include_header');
    var csvText = csvEl ? csvEl.value : '';
    var includeHeader = includeCb && includeCb.checked;
    var formData = new FormData();
    formData.append('csv_text', csvText);
    formData.append('include_header', includeHeader ? 'true' : 'false');
    formData.append('columns', headerName);
    formData.append('action', action);
    fetch('/batch-edit', { method: 'POST', body: formData })
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        var newArea = doc.getElementById('csv-area');
        if (newArea && document.getElementById('csv-area')) {
          document.getElementById('csv-area').outerHTML = newArea.outerHTML;
          if (typeof maybeRenderCsvTable === 'function') maybeRenderCsvTable();
        }
      })
      .catch(function(err) { console.error('繁简转换失败:', err); });
  }
  function convertAllColumns(action) {
    sync();
    var csvEl = document.getElementById('csv_text');
    var includeCb = document.getElementById('include_header');
    var csvText = csvEl ? csvEl.value : '';
    var includeHeader = includeCb && includeCb.checked;
    var formData = new FormData();
    formData.append('csv_text', csvText);
    formData.append('include_header', includeHeader ? 'true' : 'false');
    formData.append('action', action);
    fetch('/batch-edit', { method: 'POST', body: formData })
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        var newArea = doc.getElementById('csv-area');
        if (newArea && document.getElementById('csv-area')) {
          document.getElementById('csv-area').outerHTML = newArea.outerHTML;
          if (typeof maybeRenderCsvTable === 'function') maybeRenderCsvTable();
        }
      })
      .catch(function(err) { console.error('繁简转换失败:', err); });
  }
  function findReplaceColumn(table, colIdx, findText, replaceText, useRegex) {
    var ths = table.querySelectorAll('thead th');
    var th = ths[colIdx];
    if (!th) return;
    var headerName = (th.textContent || '').trim();
    if (!headerName || headerName === 'FileName') return;
    sync();
    var csvEl = document.getElementById('csv_text');
    var includeCb = document.getElementById('include_header');
    var csvText = csvEl ? csvEl.value : '';
    var includeHeader = includeCb && includeCb.checked;
    var formData = new FormData();
    formData.append('csv_text', csvText);
    formData.append('include_header', includeHeader ? 'true' : 'false');
    formData.append('columns', headerName);
    formData.append('fr_find', findText || '');
    formData.append('fr_replace', replaceText || '');
    formData.append('fr_regex', useRegex ? 'true' : 'false');
    formData.append('action', 'find_replace');
    fetch('/batch-edit', { method: 'POST', body: formData })
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        var newArea = doc.getElementById('csv-area');
        if (newArea && document.getElementById('csv-area')) {
          document.getElementById('csv-area').outerHTML = newArea.outerHTML;
          if (typeof maybeRenderCsvTable === 'function') maybeRenderCsvTable();
        }
      })
      .catch(function(err) { console.error('查找替换失败:', err); });
  }
  function showFindReplaceModal(table, colIdx) {
    var modal = document.getElementById('csv-find-replace-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'csv-find-replace-modal';
      modal.className = 'csv-find-replace-modal';
      modal.setAttribute('role', 'dialog');
      modal.setAttribute('aria-label', '查找替换');
      modal.innerHTML = '<div class="csv-fr-dialog"><h3>查找替换（本列）<span class="csv-fr-regex-help" id="csv-fr-regex-help" title="正则表达式说明">?</span></h3><div class="csv-fr-form"><label for="csv-fr-find">查找</label><input type="text" id="csv-fr-find" placeholder="查找内容" /><label for="csv-fr-replace">替换为</label><input type="text" id="csv-fr-replace" placeholder="替换为（正则下 \\1 表示第1组）" /><label class="csv-fr-regex-label"><input type="checkbox" id="csv-fr-regex" /> 使用正则表达式</label></div><div class="csv-fr-actions"><button type="button" class="btn csv-fr-cancel" style="background:#666;">取消</button><button type="button" class="btn csv-fr-confirm">确定</button></div></div>';
      document.body.appendChild(modal);
      modal.addEventListener('click', function(ev) {
        if (ev.target === modal) hideFindReplaceModal();
      });
      modal.querySelector('.csv-fr-cancel').addEventListener('click', hideFindReplaceModal);
      modal.querySelector('.csv-fr-confirm').addEventListener('click', doFindReplace);
      modal.addEventListener('keydown', function(ev) {
        if (ev.key === 'Escape') hideFindReplaceModal();
        else if (ev.key === 'Enter') doFindReplace();
      });
      function doFindReplace() {
        var findInput = document.getElementById('csv-fr-find');
        var replaceInput = document.getElementById('csv-fr-replace');
        var regexCb = document.getElementById('csv-fr-regex');
        var tableEl = document.getElementById('csv-data-table');
        var idx = parseInt(modal.dataset.colIdx, 10);
        if (tableEl && !isNaN(idx)) {
          findReplaceColumn(tableEl, idx, findInput ? findInput.value : '', replaceInput ? replaceInput.value : '', regexCb && regexCb.checked);
        }
        hideFindReplaceModal();
      }
      var helpIcon = document.getElementById('csv-fr-regex-help');
      if (helpIcon) {
        helpIcon.addEventListener('click', function(ev) {
          ev.stopPropagation();
          var tip = document.getElementById('csv-fr-regex-tip');
          if (tip) {
            tip.remove();
            return;
          }
          tip = document.createElement('div');
          tip.id = 'csv-fr-regex-tip';
          tip.className = 'csv-fr-regex-tip';
          tip.innerHTML = '<strong>正则表达式基本用法</strong><ul><li><code>.</code> 任意字符</li><li><code>*</code> 零次或多次</li><li><code>+</code> 至少一次</li><li><code>?</code> 零次或一次</li><li><code>[]</code> 字符类，如 <code>[0-9]</code></li><li><code>()</code> 分组，替换中用 <code>\\1</code> 引用第1组</li><li><code>^</code> 开头 <code>$</code> 结尾</li><li><code>\\d</code> 数字 <code>\\w</code> 字母数字下划线</li></ul>';
          tip.style.left = helpIcon.getBoundingClientRect().left + 'px';
          tip.style.top = (helpIcon.getBoundingClientRect().bottom + 4) + 'px';
          document.body.appendChild(tip);
          function removeTip(ev) {
            var t = document.getElementById('csv-fr-regex-tip');
            if (!t) return;
            if (t.contains(ev.target) || helpIcon.contains(ev.target)) return;
            t.remove();
            document.removeEventListener('click', removeTip);
          }
          setTimeout(function() { document.addEventListener('click', removeTip); }, 0);
        });
      }
    }
    modal.dataset.colIdx = colIdx;
    var findInput = document.getElementById('csv-fr-find');
    var replaceInput = document.getElementById('csv-fr-replace');
    if (findInput) findInput.value = '';
    if (replaceInput) replaceInput.value = '';
    modal.classList.add('open');
    if (findInput) setTimeout(function() { findInput.focus(); }, 50);
  }
  function hideFindReplaceModal() {
    var modal = document.getElementById('csv-find-replace-modal');
    if (modal) modal.classList.remove('open');
  }
  function fillColumnWithFirst(table, colIdx) {
    var trs = table.querySelectorAll('tbody tr');
    if (trs.length === 0) return;
    var firstInp = trs[0].querySelectorAll('td input')[colIdx];
    var val = firstInp ? String(firstInp.value || '') : '';
    for (var r = 0; r < trs.length; r++) {
      var inp = trs[r].querySelectorAll('td input')[colIdx];
      if (inp) inp.value = val;
    }
    sync();
  }
  function fillColumnSequential(table, colIdx) {
    var trs = table.querySelectorAll('tbody tr');
    if (trs.length === 0) return;
    var firstInp = trs[0].querySelectorAll('td input')[colIdx];
    var start = 0;
    if (firstInp && firstInp.value) {
      var n = parseInt(firstInp.value, 10);
      if (!isNaN(n)) start = n;
    }
    for (var r = 0; r < trs.length; r++) {
      var inp = trs[r].querySelectorAll('td input')[colIdx];
      if (inp) inp.value = String(start + r);
    }
    sync();
  }
  function showHeaderMenu(th, colIdx) {
    var menu = document.getElementById('csv-header-menu');
    if (!menu) {
      menu = document.createElement('div');
      menu.id = 'csv-header-menu';
      menu.className = 'csv-header-menu';
      menu.innerHTML = '<button type="button" data-action="sort-asc">排序升序</button><button type="button" data-action="sort-desc">排序降序</button><button type="button" data-action="seq">序号累加</button><button type="button" data-action="fill">填充</button><button type="button" data-action="find-replace">查找替换</button><span class="csv-header-menu-divider" id="csv-header-convert-divider"></span><button type="button" data-action="t2s">本列转简体</button><button type="button" data-action="s2t">本列转繁体</button><button type="button" data-action="t2s-all">全部列转简体</button><button type="button" data-action="s2t-all">全部列转繁体</button>';
      document.body.appendChild(menu);
      menu.addEventListener('click', function(ev) {
        var btn = ev.target.closest('button[data-action]');
        if (!btn) return;
        var table = document.getElementById('csv-data-table');
        var idx = parseInt(menu.dataset.colIdx, 10);
        if (!table || isNaN(idx)) return;
        if (btn.dataset.action === 'sort-asc') sortColumn(table, idx, true);
        else if (btn.dataset.action === 'sort-desc') sortColumn(table, idx, false);
        else if (btn.dataset.action === 'seq') fillColumnSequential(table, idx);
        else if (btn.dataset.action === 'fill') fillColumnWithFirst(table, idx);
        else if (btn.dataset.action === 'find-replace') showFindReplaceModal(table, idx);
        else if (btn.dataset.action === 't2s' || btn.dataset.action === 's2t') {
          convertColumn(table, idx, btn.dataset.action);
        } else if (btn.dataset.action === 't2s-all' || btn.dataset.action === 's2t-all') {
          convertAllColumns(btn.dataset.action === 't2s-all' ? 't2s' : 's2t');
        }
        hideHeaderMenu();
      });
      document.addEventListener('click', function(ev) {
        if (!menu.contains(ev.target) && !ev.target.closest('.csv-table th')) hideHeaderMenu();
      });
    }
    menu.dataset.colIdx = colIdx;
    var headerName = (th.textContent || '').trim();
    var fillBtn = menu.querySelector('[data-action="fill"]');
    var frBtn = menu.querySelector('[data-action="find-replace"]');
    var t2sBtn = menu.querySelector('[data-action="t2s"]');
    var s2tBtn = menu.querySelector('[data-action="s2t"]');
    var showConvert = headerName && headerName !== 'FileName';
    if (fillBtn) fillBtn.style.display = showConvert ? '' : 'none';
    if (frBtn) frBtn.style.display = showConvert ? '' : 'none';
    if (t2sBtn && s2tBtn) {
      t2sBtn.style.display = showConvert ? '' : 'none';
      s2tBtn.style.display = showConvert ? '' : 'none';
    }
    var rect = th.getBoundingClientRect();
    menu.style.left = rect.left + 'px';
    menu.style.top = (rect.bottom + 2) + 'px';
    menu.classList.add('open');
  }
  function hideHeaderMenu() {
    var menu = document.getElementById('csv-header-menu');
    if (menu) menu.classList.remove('open');
  }
  var EXCLUDE_COPY_COLS = ['FileName', 'Title', 'Number', 'Web'];
  function copyRowFromNeighbor(table, rowIdx, direction) {
    var tbody = table.querySelector('tbody');
    var trs = tbody.querySelectorAll('tr');
    var srcIdx = direction === 'prev' ? rowIdx - 1 : rowIdx + 1;
    if (srcIdx < 0 || srcIdx >= trs.length) return;
    var srcTr = trs[srcIdx];
    var curTr = trs[rowIdx];
    var headers = [];
    table.querySelectorAll('thead th').forEach(function(th) { headers.push(th.textContent.trim()); });
    var srcInputs = srcTr.querySelectorAll('input');
    var curInputs = curTr.querySelectorAll('input');
    for (var c = 0; c < headers.length && c < srcInputs.length && c < curInputs.length; c++) {
      if (EXCLUDE_COPY_COLS.indexOf(headers[c]) >= 0) continue;
      curInputs[c].value = srcInputs[c].value;
    }
    sync();
  }
  function showFilenameCellMenu(td, rowIdx) {
    var menu = document.getElementById('csv-filename-cell-menu');
    if (!menu) {
      menu = document.createElement('div');
      menu.id = 'csv-filename-cell-menu';
      menu.className = 'csv-header-menu csv-filename-cell-menu';
      menu.innerHTML = '<button type="button" data-action="copy-prev">复制上一行</button><button type="button" data-action="copy-next">复制下一行</button>';
      document.body.appendChild(menu);
      menu.addEventListener('click', function(ev) {
        var btn = ev.target.closest('button[data-action]');
        if (!btn) return;
        var table = document.getElementById('csv-data-table');
        var idx = parseInt(menu.dataset.rowIdx, 10);
        if (!table || isNaN(idx)) return;
        if (btn.dataset.action === 'copy-prev') copyRowFromNeighbor(table, idx, 'prev');
        else if (btn.dataset.action === 'copy-next') copyRowFromNeighbor(table, idx, 'next');
        hideFilenameCellMenu();
      });
      document.addEventListener('click', function(ev) {
        if (!menu.contains(ev.target) && !ev.target.closest('td.csv-row-handle')) hideFilenameCellMenu();
      });
    }
    var table = document.getElementById('csv-data-table');
    var tbody = table ? table.querySelector('tbody') : null;
    var trCount = tbody ? tbody.querySelectorAll('tr').length : 0;
    var prevBtn = menu.querySelector('[data-action="copy-prev"]');
    var nextBtn = menu.querySelector('[data-action="copy-next"]');
    if (prevBtn) prevBtn.disabled = rowIdx <= 0;
    if (nextBtn) nextBtn.disabled = rowIdx >= trCount - 1;
    menu.dataset.rowIdx = rowIdx;
    var rect = td.getBoundingClientRect();
    menu.style.left = rect.left + 'px';
    menu.style.top = (rect.bottom + 2) + 'px';
    menu.classList.add('open');
  }
  function hideFilenameCellMenu() {
    var menu = document.getElementById('csv-filename-cell-menu');
    if (menu) menu.classList.remove('open');
  }
  function render(containerId, csvText) {
    var rows = parseCSV(csvText);
    var headers = CSV_HEADERS.slice();
    var dataRows = [];
    if (rows.length) {
      var first = rows[0].map(function(c) { return String(c).trim(); });
      if (first[0] === 'FileName' || first.length >= 12) {
        headers = first.length >= 12 ? first : first.concat(CSV_HEADERS.slice(first.length));
        dataRows = rows.slice(1);
      } else {
        dataRows = rows;
      }
    }
    var wrap = document.getElementById(containerId);
    if (!wrap) return;
    wrap.innerHTML = '';
    var table = document.createElement('table');
    table.className = 'csv-table';
    table.id = 'csv-data-table';
    var thead = document.createElement('thead');
    var thr = document.createElement('tr');
    var dragSrcIdx = null;
    headers.forEach(function(h, c) {
      var th = document.createElement('th');
      th.textContent = h;
      th.dataset.colIndex = c;
      if (h !== 'FileName') {
        th.className = 'csv-th-draggable';
        th.draggable = true;
        th.addEventListener('dragstart', function(ev) {
          dragSrcIdx = parseInt(ev.target.dataset.colIndex, 10);
          ev.dataTransfer.setData('text/plain', dragSrcIdx);
          ev.dataTransfer.effectAllowed = 'move';
          ev.target.classList.add('csv-th-dragging');
        });
        th.addEventListener('dragend', function(ev) {
          ev.target.classList.remove('csv-th-dragging');
          table.querySelectorAll('th.csv-th-drop-target').forEach(function(el) { el.classList.remove('csv-th-drop-target'); });
        });
        th.addEventListener('dragover', function(ev) {
          ev.preventDefault();
          ev.dataTransfer.dropEffect = 'move';
          var idx = parseInt(ev.target.dataset.colIndex, 10);
          if (idx !== dragSrcIdx) ev.target.classList.add('csv-th-drop-target');
        });
        th.addEventListener('dragleave', function(ev) {
          ev.target.classList.remove('csv-th-drop-target');
        });
        th.addEventListener('drop', function(ev) {
          ev.preventDefault();
          ev.target.classList.remove('csv-th-drop-target');
          var toIdx = parseInt(ev.target.dataset.colIndex, 10);
          if (dragSrcIdx !== null && dragSrcIdx !== toIdx) swapColumns(table, dragSrcIdx, toIdx);
          dragSrcIdx = null;
        });
      }
      th.addEventListener('click', function(ev) {
        if (ev.target.closest('.csv-header-menu')) return;
        var idx = parseInt(ev.currentTarget.dataset.colIndex, 10);
        showHeaderMenu(ev.currentTarget, idx);
      });
      thr.appendChild(th);
    });
    thead.appendChild(thr);
    table.appendChild(thead);
    var tbody = document.createElement('tbody');
    var colCount = headers.length;
    var rowDragSrcIdx = null;
    dataRows.forEach(function(row, rowIdx) {
      var tr = document.createElement('tr');
      for (var c = 0; c < colCount; c++) {
        var td = document.createElement('td');
        var inp = document.createElement('input');
        inp.type = 'text';
        var val = row[c] != null ? String(row[c]) : '';
        inp.value = val;
        inp.dataset.col = c;
        if (c === 0) {
          inp.readOnly = true;
          inp.classList.add('csv-cell-filename');
          td.draggable = true;
          td.classList.add('csv-row-handle');
          td.addEventListener('dragstart', function(ev) {
            var trEl = ev.target.closest('tr');
            rowDragSrcIdx = Array.prototype.indexOf.call(tbody.querySelectorAll('tr'), trEl);
            ev.dataTransfer.setData('text/plain', rowDragSrcIdx);
            ev.dataTransfer.effectAllowed = 'move';
            ev.target.closest('tr').classList.add('csv-row-dragging');
          });
          td.addEventListener('dragend', function(ev) {
            ev.target.closest('tr').classList.remove('csv-row-dragging');
            table.querySelectorAll('tr.csv-row-drop-target').forEach(function(el) { el.classList.remove('csv-row-drop-target'); });
          });
          td.addEventListener('dragover', function(ev) {
            ev.preventDefault();
            ev.dataTransfer.dropEffect = 'move';
            var trEl = ev.target.closest('tr');
            var toIdx = Array.prototype.indexOf.call(tbody.querySelectorAll('tr'), trEl);
            if (toIdx !== rowDragSrcIdx) trEl.classList.add('csv-row-drop-target');
          });
          td.addEventListener('dragleave', function(ev) {
            ev.target.closest('tr').classList.remove('csv-row-drop-target');
          });
          td.addEventListener('drop', function(ev) {
            ev.preventDefault();
            var trEl = ev.target.closest('tr');
            var toIdx = Array.prototype.indexOf.call(tbody.querySelectorAll('tr'), trEl);
            trEl.classList.remove('csv-row-drop-target');
            if (rowDragSrcIdx !== null && rowDragSrcIdx !== toIdx) moveRow(table, rowDragSrcIdx, toIdx);
            rowDragSrcIdx = null;
          });
          (function(tdEl, rIdx) {
            tdEl.addEventListener('contextmenu', function(ev) {
              ev.preventDefault();
              showFilenameCellMenu(tdEl, rIdx);
            });
            tdEl.addEventListener('click', function(ev) {
              if (ev.target.closest('.csv-filename-cell-menu')) return;
              showFilenameCellMenu(tdEl, rIdx);
            });
          })(td, rowIdx);
        }
        td.appendChild(inp);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrap.appendChild(table);
  }
  function sync() {
    var table = document.getElementById('csv-data-table');
    var textarea = document.getElementById('csv_text');
    if (!table || !textarea) return;
    var headers = [];
    var ths = table.querySelectorAll('thead th');
    for (var i = 0; i < ths.length; i++) headers.push(ths[i].textContent.trim());
    var rows = [headers];
    var trs = table.querySelectorAll('tbody tr');
    for (var r = 0; r < trs.length; r++) {
      var row = [];
      var inputs = trs[r].querySelectorAll('input');
      for (var c = 0; c < inputs.length; c++) row.push(inputs[c].value);
      rows.push(row);
    }
    textarea.value = serializeCSV(rows);
  }
  window.csvEditor = { render: render, sync: sync };
  render('csv-table-wrap', initialCsv);
})();
</script>
