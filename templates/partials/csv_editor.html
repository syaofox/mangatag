{# CSV 轻量表格编辑器：隐藏 textarea 存原始 CSV，可见表格供编辑 #}
<label>CSV 编辑区</label>
<textarea id="csv_text" name="csv_text" style="display:none"></textarea>
{# 注意：为避免 CSV 内容中的 "</script" 终止脚本，这里将 JSON 中的 "</" 转义为 "<\/" #}
<script type="application/json" id="csv-initial-data">{{ csv_text | tojson | replace('</', '<\\/') }}</script>
<div id="csv-table-wrap" class="csv-table-container"></div>
<script>
(function() {
  var CSV_HEADERS = {{ csv_headers | tojson }};
  var initialDataEl = document.getElementById('csv-initial-data');
  var initialCsv = '';
  if (initialDataEl && initialDataEl.textContent) {
    try {
      initialCsv = JSON.parse(initialDataEl.textContent);
    } catch (e) {
      initialCsv = '';
    }
  }
  document.getElementById('csv_text').value = initialCsv;
  function parseCSV(text) {
    if (!text || !text.trim()) return { headers: CSV_HEADERS.slice(), rows: [] };
    var rows = [];
    var i = 0, len = text.length;
    function skipWs() { while (i < len && (text[i] === ' ' || text[i] === '\t')) i++; }
    function readField() {
      skipWs();
      if (i >= len) return '';
      if (text[i] === '"') {
        i++;
        var s = '';
        while (i < len) {
          if (text[i] === '"') {
            i++;
            if (i < len && text[i] === '"') { s += '"'; i++; }
            else break;
          } else { s += text[i]; i++; }
        }
        skipWs();
        if (i < len && text[i] === ',') i++;
        return s;
      }
      var start = i;
      while (i < len && text[i] !== ',' && text[i] !== '\r' && text[i] !== '\n') i++;
      var s = text.slice(start, i).trim();
      if (i < len && text[i] === ',') i++;
      return s;
    }
    while (i < len) {
      var row = [];
      while (i < len && text[i] !== '\r' && text[i] !== '\n') row.push(readField());
      if (row.length) rows.push(row);
      while (i < len && (text[i] === '\r' || text[i] === '\n')) i++;
    }
    return rows;
  }
  function serializeCSV(rows) {
    function escape(f) {
      var s = String(f == null ? '' : f);
      if (/[",\r\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }
    return rows.map(function(r) { return r.map(escape).join(','); }).join('\n');
  }
  function render(containerId, csvText) {
    var rows = parseCSV(csvText);
    var headers = CSV_HEADERS.slice();
    var dataRows = [];
    if (rows.length) {
      var first = rows[0].map(function(c) { return String(c).trim(); });
      if (first[0] === 'FileName' || first.length >= 12) {
        headers = first.length >= 12 ? first : first.concat(CSV_HEADERS.slice(first.length));
        dataRows = rows.slice(1);
      } else {
        dataRows = rows;
      }
    }
    var wrap = document.getElementById(containerId);
    if (!wrap) return;
    wrap.innerHTML = '';
    var table = document.createElement('table');
    table.className = 'csv-table';
    table.id = 'csv-data-table';
    var thead = document.createElement('thead');
    var thr = document.createElement('tr');
    headers.forEach(function(h) {
      var th = document.createElement('th');
      th.textContent = h;
      thr.appendChild(th);
    });
    thead.appendChild(thr);
    table.appendChild(thead);
    var tbody = document.createElement('tbody');
    var colCount = headers.length;
    dataRows.forEach(function(row) {
      var tr = document.createElement('tr');
      for (var c = 0; c < colCount; c++) {
        var td = document.createElement('td');
        var inp = document.createElement('input');
        inp.type = 'text';
        var val = row[c] != null ? String(row[c]) : '';
        inp.value = val;
        inp.size = Math.min(50, Math.max(6, val.length + 2));
        inp.dataset.col = c;
        td.appendChild(inp);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrap.appendChild(table);
  }
  function sync() {
    var table = document.getElementById('csv-data-table');
    var textarea = document.getElementById('csv_text');
    if (!table || !textarea) return;
    var headers = [];
    var ths = table.querySelectorAll('thead th');
    for (var i = 0; i < ths.length; i++) headers.push(ths[i].textContent.trim());
    var rows = [headers];
    var trs = table.querySelectorAll('tbody tr');
    for (var r = 0; r < trs.length; r++) {
      var row = [];
      var inputs = trs[r].querySelectorAll('input');
      for (var c = 0; c < inputs.length; c++) row.push(inputs[c].value);
      rows.push(row);
    }
    textarea.value = serializeCSV(rows);
  }
  window.csvEditor = { render: render, sync: sync };
  render('csv-table-wrap', initialCsv);
})();
</script>
